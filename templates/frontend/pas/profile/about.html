{% load crispy_forms_tags %}

<div id="page-about">
    <div class="row">
        <div class="col-sm-12">
            <form id="submitForm">
                {% csrf_token %}
                <div class="card card-outline">
                    <div class="card-header">
                        <div class="pull-right">
                            <button type="submit" class="btn btn-sm btn-info mt-2">
                                <span class="loading open-circle" style="display:none;"></span> Save changes
                            </button>
                        </div>
                        <h4 class="font-weight-bold mb-0">Employee Information</h4>
                        <small>You can update your employee information and other important data here.</small>
                    </div>
                    <div class="card-body" style="zoom: 95% !important;">
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>ID Number</label>
                                    <input type="text" class="form-control" name="id_number" value="{{ employee.id_number }}" >
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Account Number</label>
                                    <input type="text" class="form-control" name="account_number" value="{% if employee.account_number %}{{ employee.account_number }}{% endif %}">
                                </div>
                            </div>
                            </div>
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Position<span class="asteriskField"></span></label>
                                    <!-- <input type="hidden" name="position" value="{{ employee.position.id }}">
                                    <input type="text" class="form-control" value="{{ employee.position.name }}" > -->
                                    <select class="form-control select" name="position" >
                                        {% for row in position %}
                                            {% if row.id == employee.position_id %}
                                            <option value="{{ row.id }}" selected>{{ row.name }}</option>
                                            {% else %}
                                            <option value="{{ row.id }}">{{ row.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                                </div>                                
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label>Employment Status<span class="asteriskField"></span></label>
                                        <select class="form-control select" name="empstatus" >
                                            {% for row in empstatus %}
                                                {% if row.id == employee.empstatus_id %}
                                                <option value="{{ row.id }}" selected>{{ row.name }}</option>
                                                {% else %}
                                                <option value="{{ row.id }}">{{ row.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                    <div class="col-lg-4">
                                        <div class="form-group">
                                            <label>Section<span class="asteriskField"></span></label>
                                            <!-- <input type="hidden" name="section" value="{{ employee.section.id }}">
                                            <input type="text" class="form-control" value="{{ employee.section.sec_name }}" > -->

                                            <select class="form-control select" name="section" >
                                                {% for div in division %}
                                                <optgroup label="{{ div.div_name }}">
                                                    {% for row in section %}
                                                    {% if row.div_id == div.id %}
                                                        {% if row.id == employee.section_id %}
                                                        <option value="{{ row.id }}" selected="selected">{{ row.sec_name }}</option>
                                                        {% else %}
                                                        <option value="{{ row.id }}">{{ row.sec_name }}</option>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% endfor %}
                                                </optgroup>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div> 
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="form-group">
                                            <label>Fund Source</label>
                                            <!-- <input type="hidden" name="fund_source" value="{{ employee.fundsource.id }}">
                                            <input type="text" class="form-control" value="{{ employee.fundsource.name }}" > -->
                                            <select class="form-control select" name="fund_source" >
                                            {% for row in fundsource %}
                                            {% if row.id == employee.fundsource_id %}
                                                <option value="{{ row.id }}" selected>{{ row.name }}</option>
                                                {% else %}
                                                <option value="{{ row.id }}">{{ row.name }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        </div>
                                    </div>
                                
                                    <div class="col-lg-4">
                                        <div class="form-group" style="margin-bottom:0;">
                                            <label>Area of Assignment<span class="asteriskField"></span></label>
                                            <!-- <input type="hidden" name="aoa" value="{{ employee.aoa.id }}">
                                            <input type="text" class="form-control" value="{{ employee.aoa.name }}" > -->
                                            <select class="form-control select" name="aoa" >
                                                {% for row in aoa %}
                                                    {% if row.id == employee.aoa_id %}
                                                    <option value="{{ row.id }}" selected>{{ row.name }}</option>
                                                    {% else %}
                                                    <option value="{{ row.id }}">{{ row.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>    
                    
                                    <div class="col-lg-3">
                                        <div class="form-group" style="margin-bottom:0;">
                                            <label>Salary Rate<span class="asteriskField"></span></label>
                                            <input type="text" class="form-control" name="salary_rate" value="{{ employee.salary_rate }}" >
                                        </div>
                                        </div>
                                        </div>
                                    <div class="row">
                                    <div class="col-lg-3">
                                        <div class="form-group" style="margin-bottom:0;">
                                            <label>Salary Grade<span class="asteriskField"></span></label>
                                            <input type="text" class="form-control" name="salary_grade" value="{{ employee.salary_grade }}" >
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <div class="form-group" style="margin-bottom:0;">
                                            <label>Step Increment<span class="asteriskField"></span></label>
                                            <input type="text" class="form-control" name="step_inc" value="{{ employee.step_inc }}" >
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                
                    
                </div>

                
                <div class="card card-outline">
                    <div class="card-header">
                        <div class="pull-right">
                            <button type="submit" class="btn btn-sm btn-info mt-2">
                                <span class="loading open-circle" style="display:none;"></span> Save changes
                            </button>
                        </div>
                        <h4 class="font-weight-bold mb-0">Additional Information</h4>
                        <small>You can update employee position information here.</small>
                    </div>
                    <div class="card-body" style="zoom: 95% !important;">
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Item Number </label>
                                    <input type="text" class="form-control" name="item_number" value="{% if employee.item_number %}{{ employee.item_number }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Date of Creation of Position </label>
                                    <input type="date" class="form-control" name="docp" value="{% if employee.dateofcreation_pos %}{{ employee.dateofcreation_pos|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Designation </label>
                                    <input type="text" class="form-control" name="designation" value="{% if employee.designation %}{{ employee.designation }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Date of Designation </label>
                                    <input type="date" class="form-control" name="dod" value="{% if employee.dateof_designation %}{{ employee.dateof_designation|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Mode of Accession</label>
                                    <select class="form-control select" name="mode_access">
                                        <option></option>
                                        {% for row in mode_accession %}
                                            {% if row.id == employee.mode_access_id %}
                                            <option value="{{ row.id }}" selected>{{ row.name|title }}</option>
                                            {% else %}
                                            <option value="{{ row.id }}">{{ row.name|title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Special Order Number </label>
                                    <input type="text" class="form-control" name="special_order_no" value="{% if employee.specialorder_no %}{{ employee.specialorder_no }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Plantilla PSIPOP </label>
                                    <input type="text" class="form-control" name="plantilla" value="{% if employee.plantilla_psipop %}{{ employee.plantilla_psipop }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Type of Disability </label>
                                    <input type="text" class="form-control" name="tod" value="{% if personal_info.type_of_disability %}{{ personal_info.type_of_disability }}{% endif %}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Type of Indigenous Group </label>
                                    <select class="form-control select" name="tig">
                                        <option></option>
                                        {% for row in indi %}
                                            {% if row.id == personal_info.type_of_indi_id %}
                                            <option value="{{ row.id }}" selected>{{ row.name|title }}</option>
                                            {% else %}
                                            <option value="{{ row.id }}">{{ row.name|title }}</option>
                                            {% endif%}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Former Incumbent</label>
                                    <input type="text" class="form-control filter_employee" name="former_incumbent" value="{% if employee.former_incumbent %}{{ employee.former_incumbent }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Mode of Separation</label>
                                    <select class="form-control select" name="mode_sep">
                                        <option></option>
                                        {% for row in mode_separation %}
                                            {% if row.id == employee.mode_sep_id %}
                                            <option value="{{ row.id }}" selected>{{ row.name|title }}</option>
                                            {% else %}
                                            <option value="{{ row.id }}">{{ row.name|title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Date Vacated</label>
                                    <input type="date" class="form-control" name="date_vacated" value="{% if employee.date_vacated %}{{ employee.date_vacated|date:'Y-m-d' }}{% endif %}">
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Religion </label>
                                    <select class="form-control select" name="religion">
                                        <option></option>
                                        {% for row in religion %}
                                            {% if row.id == personal_info.reli_id %}
                                                <option value="{{ row.id }}" selected>{{ row.name|title }}</option>
                                            {% else %}
                                                <option value="{{ row.id }}">{{ row.name|title }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label>Ethnicity </label>
                                    <select class="form-control select" name="ethnicity">
                                        <option></option>
                                        {% for row in ethnicity %}
                                            {% if row.id == personal_info.ethni_id %}
                                            <option value="{{ row.id }}" selected>{{ row.name|title }}</option>
                                            {% else %}
                                            <option value="{{ row.id }}">{{ row.name|title }}</option>
                                            {% endif%}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                    </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="form-group" style="margin-bottom:0;">
                                    <label>Remarks Vacated</label>
                                    <textarea class="form-control" style="resize:vertical;" name="remarks_vacated" rows="5">{% if employee.remarks_vacated %}{{ employee.remarks_vacated }}{% endif %}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
	<div class="row">
		<div class="col-md-6">
			<div class="card card-outline">
				<form id="saveSocialMediaForm">
                    <div class="card-header">
                        <div class="pull-right">
                            <button type="submit" class="btn btn-sm btn-info mt-2">
                                <span class="loading open-circle" style="display:none;"></span> Save changes
                            </button>
                        </div>
                        <h4 class="font-weight-bold mb-0">Social Media</h4>
                        <small>You can also add your social media links here.</small>
                    </div>
                    {% csrf_token %}
                    <div class="card-body" style="zoom:95% !important;">
                        <div class="form-group">
                            <label>Facebook URL</label>
                            <input type="text" class="form-control" name="facebook_url" value="{{ sm.facebook_url }}" placeholder="e.g. www.facebook.com/profile/" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Instagram URL</label>
                            <input type="text" class="form-control" name="instagram_url" value="{{ sm.instagram_url }}" placeholder="e.g. www.instagram.com/account/" autocomplete="off">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Twitter URL</label>
                            <input type="text" class="form-control" name="twitter_url" value="{{ sm.twitter_url }}" placeholder="e.g. www.twitter.com/feed/" autocomplete="off">
                        </div>
                    </div>
				</form>
			</div>
		</div>
		<div class="col-sm-6">
			<div class="card card-outline">
                <form id="saveIncaseForm">
                    <div class="card-header">
                        <div class="pull-right">
                            <button type="submit" class="btn btn-sm btn-info mt-2">
                                <span class="loading open-circle" style="display:none;"></span> Save changes
                            </button>
                        </div>
                        <h4 class="font-weight-bold mb-0">Other Contact Information</h4>
                        <small>These are information you have provided for emergency purposes.</small>
                    </div>
                    {% csrf_token %}
                    <div class="card-body" style="zoom: 95% !important;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Your Email</label>
                                    <input type="text" class="form-control" value="{{ employee.pi.user.email }}" autocomplete="off" >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Your Contact</label>
                                    <input type="text" class="form-control" value="{{ employee.pi.mobile_no }}" autocomplete="off" >
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Contact In Case of Emergency<span class="asteriskField">*</span></label>
                            <input type="text" class="form-control" name="contact_name" value="{{ incase.contact_name }}" autocomplete="off">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Contact Number<span class="asteriskField">*</span></label>
                            <input type="text" class="form-control" name="contact_number" maxlength="11" value="{{ incase.contact_number }}" autocomplete="off">
                        </div>
                    </div>
                </form>
			</div>
		</div>
	</div>
	<div class="row mb-0">
		<div class="col-lg-12">
			<div class="card card-outline mb-0">
				<form id="submitPassForm">
		            <div class="card-header">
			            <div class="pull-right">
							<button type="submit" class="btn btn-sm btn-info mt-2">
								<span class="loading open-circle" style="display:none;"></span> Save changes
							</button>
			            </div>
		                <h4 class="font-weight-bold mb-0">Security Settings</h4>
						<small>After you change your password here, your accounts in Active Directory and Global Protect will be changed too.</small>
		            </div>
		            {% csrf_token %}
		            <div class="card-body">
                        <div class="row"    >
                            <div class="col-4">
                                <div class="form-group mb-0">
                                    <label>Old Password<span class="asteriskField">*</span></label>
                                    <input type="password" class="form-control" name="old_password" required>
                                    <small class="text-danger" id="error-msg"></small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group mb-0">
                                    <label>New Password<span class="asteriskField">*</span></label>
                                    <input type="password" class="form-control" name="new_password" id="new_password" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group mb-0" style="margin-bottom:0;">
                                    <label>Confirm New Password<span class="asteriskField">*</span></label>
                                    <input type="password" class="form-control" name="confirm_password" id="confirm_password" required>
                                    <small class="text-danger" id="confirm-msg"></small>
                                </div>
                            </div>
                        </div>
		            </div>
	            </form>
	        </div>
		</div>
	</div>

        
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card card-outline mb-0">
                <form id="submitSignature" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="card-header">
                    <div class="pull-right">
                        <button type="submit" class="btn btn-sm btn-info mt-2">
                        <span class="loading open-circle" style="display:none;"></span>
                        {% if user_signature %}
                            Update Signature
                        {% else %}
                            Save changes
                        {% endif %}
                        </button>
                    </div>
                    <h4 class="font-weight-bold mb-0">Digital Signature</h4>
                    <small>
                        {% if user_signature %}
                        Your uploaded signature is shown below. You can update it if needed.
                        {% else %}
                        Upload your signature image and optionally your <strong>.P12</strong> digital certificate file.
                        {% endif %}
                    </small>
                    </div>

                    <div class="card-body">
                    <div class="row">
                        <!-- Signature Image -->
                        <div class="col-md-3">
                        <div class="form-group mb-0">
                            <small>Signature Image (.PNG/.JPG)<span class="asteriskField">*</span></small>

                            {% if user_signature and user_signature.signature_img %}
                            <div class="mb-1">
                                <span class="badge bg-success">Already uploaded</span>
                            </div>
                            <div class="mb-2">
                                <img src="{{ user_signature.signature_img.url }}" alt="Uploaded Signature" class="img-fluid border">
                            </div>
                            <input type="file" name="signature_img" class="form-control" accept=".png,.jpg,.jpeg">
                            <small class="text-muted">Upload a new image to replace the current signature.</small>
                            {% else %}
                            <input type="file" name="signature_img" class="form-control" accept=".png,.jpg,.jpeg" required>
                            {% endif %}
                        </div>
                        </div>

                        <!-- Digital Certificate -->
                        <div class="col-md-3">
                        <div class="form-group mb-0">
                            <small>Digital Certificate (.p12) <em>(Optional)</em></small>
                            {% if user_signature and user_signature.p12_file %}
                            <div class="mb-1">
                                <span class="badge bg-success">Already uploaded</span>
                            </div>
                            {% endif %}
                            <input type="file" name="p12_file" class="form-control" accept=".p12,.pem,.pfx">
                        </div>
                        </div>

                        <!-- Authentication Password -->
                        <div class="col-md-6">
                        <div class="form-group mb-0">
                            <small>Authentication Password<span class="asteriskField">*</span></small>
                            <div class="input-group">
                            <input type="password" name="p12_password" class="form-control"
                                    placeholder="Enter your authentication password" required>
                            <button type="button" class="btn btn-outline-secondary border-start-0"
                                    onclick="const i=this.previousElementSibling;const isPassword=i.type==='password';i.type=isPassword?'text':'password';this.innerHTML=isPassword?'üëÅÔ∏è':'üëÅÔ∏è‚Äçüó®Ô∏è';">
                                üëÅÔ∏è
                            </button>
                            </div>
                            <small class="text-muted">
                            If you upload a .p12 certificate, this will be your certificate password.
                            Otherwise, this will be used for signature authentication.
                            </small>
                        </div>
                        </div>
                    </div>
                    </div>
                </form>
            </div>
        </div>
     </div>

</div>
{% block script %}
<script type="text/javascript">
	$.get('{% url "filter-incumbent" %}', function(data){
        $(".filter_employee").typeahead({
            source:data,
            highlight: true
        });
    },'json');

	$('#submitForm').on('submit', function(e){
        e.preventDefault();
        var form = new FormData(this);
        $.ajax({
            url: '{% url "about" %}',
            type: "POST",
            data: form,
            beforeSend: function() {
                $('.loading').css('display', '');
                $('button').prop("disabled", true);
            },
            success: function (response) {
                if(response.data) {
                    Swal.fire({
                        title: "Good job!",
                        text: "Personal employee information was updated successfully.",
                        icon: "success",
                        confirmButtonColor: "#3498DB",
                    });
                }
            },
            complete: function(){
                $('.loading').css('display', 'none');
                $('button').prop("disabled", false);
            },
            cache: false,
            contentType: false,
            processData: false
        });
    });

	$('.select').select2({
		width: "100%",
		allowClear: true,
		placeholder: 'Choose',
	});

	$('#saveSocialMediaForm').on('submit', function(e){
		e.preventDefault();
		$.ajax({
			url: '{% url "social_media" %}',
			type: "POST",
			data: new FormData(this),
			success: function (response) {
				if (response.data == "success"){
					Swal.fire({
						title: "Good job!",
						html: "Social media URLs successfully updated.",
						icon: "success",
						confirmButtonColor: "#3498DB",
					});
				}
			},
			cache: false,
			contentType: false,
			processData: false
		});
	});

	$('#saveIncaseForm').on('submit', function(e){
		e.preventDefault();
		$.ajax({
			url: '{% url "incase_of_emergency" %}',
			type: "POST",
			data: new FormData(this),
			success: function (response) {
				if (response.data == "success"){
					Swal.fire({
						title: "Good job!",
						html: "Incase of emergency details successfully updated.",
						icon: "success",
						confirmButtonColor: "#3498DB",
					});
				}
			},
			cache: false,
			contentType: false,
			processData: false
		});
	});


    $('#submitSignature').on('submit', function(e){
    e.preventDefault();
    $.ajax({
        url: '{% url "signature" %}',
        type: "POST",
        data: new FormData(this),
        success: function (response) {
            if (response.data == "success"){
                Swal.fire({
                    title: "Good job!",
                    html: "You successfully submitted your Certificate and Signature Image.",
                    icon: "success",
                    confirmButtonColor: "#3498DB",
                }).then(() => {
                    location.reload(); 
                });
            }
        },
        cache: false,
        contentType: false,
        processData: false
    });
});

	$('#submitPassForm').on('submit', function(e){
		e.preventDefault();
		$form = $(this);
		if($('#new_password').val() == $('#confirm_password').val()){
			$.ajax({
				url: '{% url "change-password" %}',
				type: "POST",
				data: new FormData(this),
				beforeSend: function(){
					$('.loading').css('display', '');
					$('button').prop("disabled", true);
				},
				success: function (response) {
					if (response.error){
						$('#error-msg').text('Invalid old password!');
						$('#confirm-msg').empty();
					} else if (response.confirm){
						$('#confirm-msg').text('Passwords do not match!');
						$('#error-msg').empty();
					}
					else {
						$('#error-msg').empty();
						$('#confirm-msg').empty();
						$('#submitPassForm').trigger('reset');
						Swal.fire({
							title: "Good job!",
							html: "Your password was successfully updated",
							icon: "success",
							confirmButtonColor: "#3498DB",
						});
					}
				},
				complete: function(){
					$('.loading').css('display', 'none');
					$('button').prop("disabled", false);
				},
				cache: false,
				contentType: false,
				processData: false
			});
		}else{
			$('#confirm-msg').text('Passwords do not match!');
			$('#error-msg').empty();
		}
	});
</script>
{% endblock %}

