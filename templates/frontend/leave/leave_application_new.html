{% extends 'layout.html' %}
{% load frontend_tags %}
{% load tags %}
{% load static %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>


        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card-content {
            padding: 20px;
        }

        .icon-wrapper {
            padding: 0.5rem;
            background: #e0f2fe;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            color: #0891b2;
        }

        /* Leave Request Information Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-value {
            font-weight: 600;
            color: #0f172a;
            font-size: 1rem;
        }

        .info-value.large {
            font-size: 1.125rem;
        }

        /* Progress Timeline */
        .progress-container {
            position: relative;
            padding: 0px;
        }

        .progress-line {
            position: absolute;
            top: 4rem;
            left: 4rem;
            right: 4rem;
            height: 2px;
            background: #e2e8f0;
            border-radius: 1px;
        }

        .progress-active {
            position: absolute;
            top: 4rem;
            left: 4rem;
            height: 2px;
            background: linear-gradient(to right, #06b6d4, #10b981);
            border-radius: 1px;
            transition: width 1s ease-out;
            width: 50%; /* Adjust based on completion */
        }

        .timeline-steps {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
        }

        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 120px;
        }

        .step-indicator {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            border: 4px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .step-indicator:hover {
            transform: scale(1.05);
        }

        .step-indicator.approved {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #34d399;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.25);
        }

        .step-indicator.rejected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #f87171;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.25);
        }

        .step-indicator.pending {
            background: white;
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .step-indicator.pending::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 4px solid #cbd5e1;
            animation: pulse 2s infinite;
            opacity: 0.5;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .step-number {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: white;
            color: #475569;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid white;
        }

        .step-info {
            margin-top: 1rem;
            text-align: center;
            max-width: 6rem;
        }

        .step-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.25rem;
        }

        .step-approver {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .step-date {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Status Icons */
        .status-icon {
            width: 1.5rem;
            height: 1.5rem;
            color: white;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .status-icon.pending {
            color: #64748b;
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Approval Cards Grid */
        .approval-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .approval-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .approval-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .approval-card.approved {
            background: linear-gradient(135deg, #ecfdf5, white);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1);
        }

        .approval-card.rejected {
            background: linear-gradient(135deg, #fef2f2, white);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.1);
        }

        .approval-card.pending {
            background: linear-gradient(135deg, #f8fafc, white);
        }

        .approval-card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .approval-card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        :root{
            --circle-size: 48px;
            --badge-size: 22px;
            --head-height: 74px; /* reserve consistent space for badge+circle */
            --rail-height: 6px;
            }

            .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
            }

            /* Fixed-height header so all circles align */
            .step-head{
            position: relative;
            height: var(--head-height);
            display: flex;
            align-items: center;
            justify-content: center;
            }

            /* Small number badge above the circle */
            .step-number{
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: var(--badge-size);
            height: var(--badge-size);
            border-radius: 50%;
            background: #6c757d;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            }

            /* Main status circle */
            .circle {
            width: var(--circle-size);
            height: var(--circle-size);
            margin: auto;
            border-radius: 50%;
            border: 2px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px; /* icon size */
            font-weight: bold;
            transition: background-color .3s, border-color .3s, color .3s;
            }

            /* Status colors (works for both circle & optional number badge) */
            .bg-success { background-color:#28a745 !important; border-color:#28a745 !important; color:#fff !important; }
            .bg-danger  { background-color:#dc3545 !important; border-color:#dc3545 !important; color:#fff !important; }
            .bg-light   { background-color:#f8f9fa !important; color:#6c757d !important; }

            /* Progress rail sits at the vertical center of the circles */
            .tracker { position: relative; max-width: 900px; margin: auto; }
            .tracker .progress{
            position: absolute;
            left: 0; right: 0;
            height: var(--rail-height);
            top: calc(var(--head-height) - (var(--circle-size) / 2) - (var(--rail-height) / 2));
            z-index: 1;
            background-color: #e9ecef;
            border-radius: 3px;
            }
            .tracker .progress-bar { transition: width 0.5s ease; }

            /* Label spacing */
            .step-label{ margin-top: 16px; margin-bottom: 0; font-weight: 600; }

            /* Name/date box; wraps long names */
            .step-info{
            display: block;
            margin-top: 6px;
            padding: 6px 8px;
            font-size: .85rem;
            line-height: 1.2;
            /* background: #f8f9fa;
            border-radius: 6px; */
            max-width: 160px;     /* adjust as needed */
            margin-left: auto;
            margin-right: auto;
            word-wrap: break-word;
            white-space: normal;
            text-align: center;
            }

            /* Optional: color the number badge by status */
            .num-success{ background:#198754; }
            .num-danger{  background:#dc3545; }
            .num-pending{ background:#6c757d; }

            

</style>
{% endblock %}
{% block content %}
<div class="container-fluid">
	<div class="row px-3 pt-3">
		<div class="col-lg-8">
			<h1 class="font-weight-bold">{{ tab_title }}</h1>
			<ol class="breadcrumb bg-transparent p-0">
				<li class="breadcrumb-item">
					<a href="{% url 'backend-dashboard' %}">Home</a>
				</li>
				<li class="breadcrumb-item">
					{{ tab_parent }}
				</li>
				<li class="breadcrumb-item active">
					<strong>{{ tab_title }}</strong>
				</li>
			</ol>
		</div>
		<div class="col-lg-4 pt-3">
			<div class="float-md-right">

                <button class="btn btn-info" data-toggle="modal" data-target="#credits-request"><i class="fas fa-plus"></i> Credits Request</button>
                <button class="btn btn-info" data-toggle="modal" data-target="#apply-leave"><i class="fas fa-plus"></i> Request for Leave</button>
			</div>
		</div>
	</div>
</div>

    <div class="content-wrapper p-4 ml-0">
    <div class="row">
        <div class="col-sm-9">
            <div class="card card-info card-tabs">
                <div class="card-header p-0 pt-1">
                    <ul class="nav nav-tabs" id="tabUL">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#leaveApplication">Leave Application <span id="total-leave-application" class="badge badge-warning"></span></a>                            
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#Leave_for_approval">For Approval <span id="total-leave-for-approval" class="badge badge-danger"></span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#tracking_tab">Tracking </a>
                        </li>
               
                        <li class="nav-item">
                            <a class="nav-link" data-toggle="tab" href="#credits_request">Compensatory Credit Request </a>
                        </li>
                    </ul>
                </div>

                

                <div class="card-body">
                    <div class="tab-content">
                        <!-- Leave Application Tab -->
                        <div class="tab-pane fade show active" id="leaveApplication">
                            <div class="table-responsive">
                                <table id="leave-table" class="table table-bordered table-hover" style="zoom:95% !important;" width="100%">
                                    <thead>
                                        <tr>
                                            <th class="capslock text-left" width="15%">Action</th>
                                            <th width="10%">TRACKING NO.</th>
                                            <th class="capslock">Leave Type</th>
                                            <th class="capslock text-center">Inclusive Dates</th>
                                            <th class="capslock text-center">Date of Filing</th>
                                            <th class="capslock text-right">Status</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="Leave_for_approval">
                            <!-- For Approval Tab -->
                            <div class="table-responsive">
                                <table id="approval-table" class="table table-bordered table-hover" style="zoom:95% !important;" width="100%">
                                    <thead>
                                        <tr>
                                            <th class="text-center" width="15%">ACTION</th>
                                            <th class="text-right" width="20%">LEAVE PURPOSE</th>
                                            <th class="text-center" width="15%">LEAVE NO.</th>
                                            <th class="text-center" width="25%">INCLUSIVE DATE</th>
                                            <th class="text-center" width="15%">REQUESTER</th>
                                            <th class="text-center" width="15%">DATE FILED</th>
                                            <th class="text-right" width="20%">LEAVE STATUS</th>
                                            
                                            
                                        </tr>
                                    </thead>
                                </table>

                            </div>
                        </div>



                        
                        <div id="tracking_tab" class="tab-pane">
                                <div class="panel-body">
                                    <div class="tracking-container text-center">
                                        <div class="mb-4 position-relative" style="max-width:400px; margin:auto;">
                                            <label for="trackingNo" class="form-label fw-bold">Search Tracking No:</label>
                                            <div class="input-group justify-content-center" style="max-width:400px; margin:auto;">
                                                <input type="text" id="trackingNo" class="form-control" placeholder="Enter Tracking No." autocomplete="off">
                                                <ul id="trackingList" class="list-group position-absolute w-100" style="z-index:1000; display:none;"></ul>
                                                <button class="btn btn-primary" id="btn-TrackLeave">Search</button>
                                            </div>
                                        </div>

                                        <div id="trackingResult" class="mt-4"></div>
                                    </div>
                                </div>
                            </div>




                        <div class="tab-pane fade" id="credits_request">
                            <div class="table-responsive">
                                <table id="credits-request-table" class="table table-bordered table-hover" style="zoom:95% !important;" width="100%">
                                    <thead>
                                        <tr>
                                            <th class="text-center" width="15%">ACTION</th>
                                            <th class="text-center" width="15%">TRACKING NO</th>
                                            <th class="text-center" width="15%">ATTACHMENT</th>
                                            <th class="text-center display-none" width="15%">REQUESTER NAME</th>
                                            <th class="text-center" width="25%">DATE & TIME REQUEST</th>
                                             <th class="text-center" width="25%">APPROVED DATE</th>
                                             <th class="text-center" width="25%">REMARKS</th>
                                            <th class="text-center" width="15%">Status</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>    
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-3">
            <div class="card">
                <div class="card-header bg-info">
                    <h5 class="card-title font-weight-bold">FILTER</h5>
                </div>
                <div class="card-body">
                    <h4>By status</h4>
                    <div class="list-group">
                        <a class="list-group-item list-group-item-action active" id="status-all" href="javascript:;" data-role="status" data-filter="all">All</a>
                        <a class="list-group-item list-group-item-action" id="status-0" href="javascript:;" data-role="status" data-filter="0">Pending</a>
                        <a class="list-group-item list-group-item-action" id="status-1" href="javascript:;" data-role="status" data-filter="1">Approved</a>
                        <a class="list-group-item list-group-item-action" id="status-2" href="javascript:;" data-role="status" data-filter="2">Cancelled</a>
                    </div>
                </div>
            </div>





            <div class="card">
                <div class="card-header bg-info">
                    <h5 class="card-title font-weight-bold">LEAVE CREDITS</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for row in leave_credits %}
                            <a {% if row.updated_on %}rel="tooltip" data-placement="top" title="As of {{ row.updated_on|date:'F d, Y' }}"{% endif %}
                               class="list-group-item list-group-item-action">
                               {{ row.leavetype.name }}
                               <span class="pull-right">{{ row.leave_total }}</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="credits-request" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
            <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">
                    Request Compensatory Credits
                </h3>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
            </div>

            <form id="submitCreditsForm" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="form-group col-md-12">
                            <label>Attachment</label><span class="asteriskField">*</span>
                            <input type="file" name="attachment" class="form-control" accept="application/pdf" required>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-info">Submit</button>
                </div>
            </form>
        </div>
    </div>  
</div>



<div class="modal" id="apply-leave" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content animated bounceInDown">
	        <div class="modal-header bg-info">
	            <h3 class="modal-title">
					{{ tab_title|upper }}

				</h3>
				<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        </div>
	        
            <form id="submitLeaveForm">
	        <div class="modal-body">
				{% csrf_token %}
	        	<div class="row">
		        	<div class="form-group col-md-12">
		        		<label>Type of Leave<span class="asteriskField">*</span></label>
		        		<select class="form-control select" name="leavesubtype" id="leavesubtype" required>
		        			<option></option>
		        			{% for row in leavesubtype %}
 		        			<option value="{{ row.leavesubtype.id }}">{{ row.leavesubtype.name }} {% if row.leavesubtype.description %}({{ row.leavesubtype.description}}){% endif %}</option>
							{% endfor %}
		        		</select>
		        	</div>
	        	</div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="row content"></div>
                    </div>
                </div>
				<div class="row" id="filter_content" style="display: none;">
					<div class="form-group col-md-12">
						<label>Filter Dates By<span class="asteriskField">*</span></label>
						<select class="form-control select" id="filter_dates" required>
							<option></option>
							<option value="range">Range</option>
							<option value="random">Custom</option>
						</select>
					</div>
				</div>
	        	<div class="row" id="inclusive_dates" style="display:none;">
		        	<div class="form-group col-md-6">
		        		<label>Start Date<span class="asteriskField">*</span></label>
		        		<input type="date" name="start_date" id="start_date" class="form-control b-r-sm">
		        	</div>
		        	<div class="form-group col-md-6">
		        		<label>End Date<span class="asteriskField">*</span></label>
		        		<input type="date" name="end_date" id="end_date" class="form-control b-r-sm">
		        	</div>
	        	</div>
				<div id="random_dates" style="display:none;">
					<div id="items">
						<div class="row">
							<div class="form-group col-md-12">
								<div class="input-group">
									<input type="date" class="form-control b-r-sm dates" name="dates[]">
									<div class="input-group-append"> <button type="button" class="btn btn-info add"><i class="fas fa-plus"></i></button> </div>
								</div>
							</div>
						</div>
					</div>
				</div>

                <!-- <div class="row" id="file_upload_container" style="display:none;">
                    <div class="form-group col-md-12">
                        <label>Supporting Document <span class="asteriskField">*</span></label>
                        <input type="file" name="file" id="file" class="form-control" accept=".pdf,.jpg,.png,.jpeg">
                    </div>
                </div> -->
			</div>
            <div class="modal-footer">
				<button type="submit" class="btn btn-info">Submit</button>
            </div>
	        </form>
	    </div>
	</div>
</div>

<div class="modal" id="leave-attachment-modal" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content animated bounceInDown">
			<div class="modal-header bg-info">
				<h3 class="modal-title">LEAVE APPLICATION ATTACHMENT</h3>
				<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
			</div>
			<div id="leave-attachment-content"></div>
		</div>
	</div>
</div>

<div class="modal" id="edit-leave" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content animated bounceInDown">
	        <div class="modal-header bg-info">
	            <h3 class="modal-title">
					EDIT LEAVE APPLICATION

				</h3>
				<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
	        </div>
			<div id="edit-content"></div>
		</div>
	</div>
</div>



<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info d-flex justify-content-between align-items-center">
        <h3 class="modal-title">Preview Attachment File</h3>
        <div>
          <button type="button" class="btn btn-sm btn-secondary me-2" id="fullscreenBtn" title="Fullscreen">
            â›¶
          </button>
			<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <iframe id="previewFrame" src="" style="width:100%; height:70vh;" frameborder="0"></iframe>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block script %}

{% include 'frontend/leave/modals/set_signatories.html' %}

<script type="text/javascript">
	$(document).on('click', 'a[data-role=status]', function(){
    	$('.list-group-item').removeClass('active');
		$('#status-'+$(this).data('filter')).addClass('active');
    	if($(this).data('filter') == 'all'){
    		$('#leave-table').DataTable().ajax.url('/api/leave/application/?format=datatables&employee_id={% getHash request.session.emp_id %}').load();
    	}else{
			$('#leave-table').DataTable().ajax.url('/api/leave/application/?format=datatables&employee_id={% getHash request.session.emp_id %}&status='+$(this).data('filter')).load();
		}
	});
LeaveTable();


function LeaveTable() {
    $('#leave-table').DataTable({
        'serverSide': true,
        'processing': true,
        'deferRender': true,
        'lengthMenu': [25, 50, 100],
        'order': [[4, 'desc']],
        'ajax': {
            'url': '/api/leave/application/?format=datatables&employee_id={% getHash request.session.emp_id %}',
            'type': 'GET',
            'beforeSend': function (request) {
                request.setRequestHeader("Authorization", "Token 82b88a7bdac1ea3868361448927035e93b0dc19d");
            }
        },
        'fnCreatedRow': function (row, data, index) {
            $(row).attr('id', data['id']);
        },
        "columnDefs": [
            { "orderable": false, "targets": [0, 2, 5] },
            { "orderable": true, "targets": [1, 3, 4] }
        ],
        'columns': [
            { 'data': 'action', 'orderable': false,'searchable':false }, 
            { 'data': 'tracking_no'  },
            { 'data': 'leavesubtype_name', 'className': 'text-center', 'name': 'leavesubtype.name','searchable':'true','orderable':'false' },
            { 'data': 'inclusive_dates', 'className': 'text-center', 'name': 'remarks, start_date, end_date' },
            { 'data': 'date_of_filing', 'className': 'text-center' },
            { 'data': 'get_status', 'orderable': false, 'searchable': false, 'className': 'text-right' }
            
        ]
    });
}

	function _0x5d52(){var _0x4ded4e=['#random_dates','removeAttr','css','change','2630rkYaRd','14ZOJvgv','3049dVCgjv','random','5125824TgSIIr','#filter_dates','46640tihpkM','display','#end_date','1126KqZBHN','none','2830788UbeCnG','8272845iqMDmM','785JDfIaA','required','6577408CoBHmu','val','attr','52314UVKTjv','#start_date'];_0x5d52=function(){return _0x4ded4e;};return _0x5d52();}var _0x411ec3=_0x241f;function _0x241f(_0x1321eb,_0x334266){var _0x5d52e0=_0x5d52();return _0x241f=function(_0x241f11,_0x346300){_0x241f11=_0x241f11-0x1db;var _0x36351e=_0x5d52e0[_0x241f11];return _0x36351e;},_0x241f(_0x1321eb,_0x334266);}(function(_0x2d3708,_0xdd2bc5){var _0x207ecf=_0x241f,_0x44f521=_0x2d3708();while(!![]){try{var _0x6169a2=-parseInt(_0x207ecf(0x1ea))/0x1*(-parseInt(_0x207ecf(0x1f1))/0x2)+parseInt(_0x207ecf(0x1db))/0x3+-parseInt(_0x207ecf(0x1ec))/0x4+parseInt(_0x207ecf(0x1dd))/0x5*(parseInt(_0x207ecf(0x1e2))/0x6)+parseInt(_0x207ecf(0x1e9))/0x7*(-parseInt(_0x207ecf(0x1df))/0x8)+parseInt(_0x207ecf(0x1dc))/0x9+parseInt(_0x207ecf(0x1e8))/0xa*(-parseInt(_0x207ecf(0x1ee))/0xb);if(_0x6169a2===_0xdd2bc5)break;else _0x44f521['push'](_0x44f521['shift']());}catch(_0x388628){_0x44f521['push'](_0x44f521['shift']());}}}(_0x5d52,0xdd84f),$(_0x411ec3(0x1ed))['on'](_0x411ec3(0x1e7),function(){var _0xcfc9b3=_0x411ec3;if($(this)[_0xcfc9b3(0x1e0)]()=='range')$(_0xcfc9b3(0x1e4))[_0xcfc9b3(0x1e6)](_0xcfc9b3(0x1ef),_0xcfc9b3(0x1f2)),$('.dates')[_0xcfc9b3(0x1e5)](_0xcfc9b3(0x1de)),$('#inclusive_dates')[_0xcfc9b3(0x1e6)]('display',''),$(_0xcfc9b3(0x1e3))[_0xcfc9b3(0x1e1)](_0xcfc9b3(0x1de),_0xcfc9b3(0x1de)),$(_0xcfc9b3(0x1f0))['attr']('required',_0xcfc9b3(0x1de));else $(this)['val']()==_0xcfc9b3(0x1eb)&&($('#inclusive_dates')['css'](_0xcfc9b3(0x1ef),_0xcfc9b3(0x1f2)),$('#start_date')[_0xcfc9b3(0x1e5)](_0xcfc9b3(0x1de)),$(_0xcfc9b3(0x1f0))[_0xcfc9b3(0x1e5)](_0xcfc9b3(0x1de)),$(_0xcfc9b3(0x1e4))[_0xcfc9b3(0x1e6)](_0xcfc9b3(0x1ef),''),$('.dates')['attr'](_0xcfc9b3(0x1de),_0xcfc9b3(0x1de)));}));

	function _0x5150(_0x5ed411,_0x3bdde1){var _0x21a40c=_0x21a4();return _0x5150=function(_0x515033,_0x35e5c6){_0x515033=_0x515033-0xf5;var _0x13d72f=_0x21a40c[_0x515033];return _0x13d72f;},_0x5150(_0x5ed411,_0x3bdde1);}var _0x40e5d0=_0x5150;function _0x21a4(){var _0x4688a7=['<div\x20class=\x22row\x22><div\x20class=\x22form-group\x20col-md-12\x22><div\x20class=\x22input-group\x22><input\x20type=\x22date\x22\x20class=\x22form-control\x20b-r-sm\x20dates\x22\x20name=\x22dates[]\x22>\x20<span\x20class=\x22input-group-btn\x22>\x20<button\x20type=\x22button\x22\x20class=\x22btn\x20btn-danger\x20remove_field\x22\x20style=\x22height:\x2034px;\x22><i\x20class=\x22fas\x20fa-minus\x22></i></button>\x20</span></div></div></div>','1VXGoUs','179524rFvuQG','602381WZVgaF','5744272zuJyZo','parent','1323800ncbuaN','32394JsoTga','1670nlvJYE','665StrkIt','remove','.remove_field','16357PpeEJM','9SesAQX','#items','822166ZjDSwL','36mjwbQc','42pNdauv','click'];_0x21a4=function(){return _0x4688a7;};return _0x21a4();}(function(_0x512d91,_0x2b4f5a){var _0x22bbc7=_0x5150,_0x36d62a=_0x512d91();while(!![]){try{var _0x2c4a21=-parseInt(_0x22bbc7(0x105))/0x1*(-parseInt(_0x22bbc7(0x100))/0x2)+-parseInt(_0x22bbc7(0x102))/0x3*(parseInt(_0x22bbc7(0x106))/0x4)+parseInt(_0x22bbc7(0xf7))/0x5+parseInt(_0x22bbc7(0xf8))/0x6*(-parseInt(_0x22bbc7(0xfa))/0x7)+parseInt(_0x22bbc7(0xf5))/0x8*(parseInt(_0x22bbc7(0xfe))/0x9)+parseInt(_0x22bbc7(0xf9))/0xa*(parseInt(_0x22bbc7(0xfd))/0xb)+parseInt(_0x22bbc7(0x101))/0xc*(-parseInt(_0x22bbc7(0x107))/0xd);if(_0x2c4a21===_0x2b4f5a)break;else _0x36d62a['push'](_0x36d62a['shift']());}catch(_0x2ccf5d){_0x36d62a['push'](_0x36d62a['shift']());}}}(_0x21a4,0x585e4),$('.add')['on'](_0x40e5d0(0x103),function(){var _0x15e27c=_0x40e5d0;$(_0x15e27c(0xff))['append'](_0x15e27c(0x104));}),$(_0x40e5d0(0xff))['on'](_0x40e5d0(0x103),_0x40e5d0(0xfc),function(_0x2b63fc){var _0x5c9271=_0x40e5d0;$(this)[_0x5c9271(0xf6)]()[_0x5c9271(0xf6)]()[_0x5c9271(0xf6)]()[_0x5c9271(0xfb)]();}));

	$('#leavesubtype').on('change', function() {
    var selectedId = $(this).val();
    if (!selectedId) {
        return;
    }
    $.ajax({
        url: "{% url 'get_leavespent' %}",
        data: {
            id: selectedId
        },
        type: "POST"
    })
    .done(function(data) {	
			var value = data.data;
			template = '';
			$('.content').empty();

			if (value.length != 0){
				for(var row=0; row < value.length; row++){
					if(row == 0){
						template += "<div class='col-sm-6'>";
						template += "<div class='form-group'>";
						if (value[row]['is_specify'] == 0){
    						template += "<input type='checkbox' class='check leavespent_check' name='leavespent_check' value='"+ value[row]['id'] +"' checked> &nbsp;" + value[row]['name'];
						} else {
    						template += "<input type='checkbox' class='check leavespent_check' name='leavespent_check' value='"+ value[row]['id'] +"' checked> &nbsp;" + value[row]['name'];
							template += "<input type='text' class='form-control b-r-sm leavespent_specify' id='leavespent_specify" + value[row]['id'] + "' name='leavespent_specify"+ value[row]['id'] +"' placeholder='Specify' autocomplete='off'>";
						}
						template += "</div>";
						template += "</div>";
					}else{
						template += "<div class='col-sm-6'>";
						template += "<div class='form-group'>";
						if (value[row]['is_specify'] == 0){
    						template += "<input type='checkbox' class='check leavespent_check' name='leavespent_check' value='"+ value[row]['id'] +"'> &nbsp;" + value[row]['name'];
						} else {
    						template += "<input type='checkbox' class='check leavespent_check' name='leavespent_check' value='"+ value[row]['id'] +"'> &nbsp;" + value[row]['name'];
							template += "<input type='text' class='form-control b-r-sm leavespent_specify' id='leavespent_specify" + value[row]['id'] + "' name='leavespent_specify"+ value[row]['id'] +"' placeholder='Specify' autocomplete='off'>";
						}
						template += "</div>";
						template += "</div>";
					}
				}
				{#template += "<p class='text-danger' style='zoom:80%;'>Note: Please do check the checkboxes if applicable and specify your reason for leave.</p>";#}

				$(document).on('click', '.leavespent_check', function(){
					$(".leavespent_check").prop('checked', false);
					$('.leavespent_specify').removeAttr("required");
					$("#leavespent_specify" + $(this).val()).prop("required", "true");
					$(this).prop('checked', true);
				});
			}

			if (data.has_reason){
				template += '<div class="col-sm-12">';
				template += '<div class="form-group">';
				template += '<label>Reason for Leave</label>';
				template += '<textarea class="form-control" name="reasons" placeholder="Write reason for filing a leave" required></textarea>';
				template += '</div>';
				template += '</div>';
			}

			if (data.remarks_text){
				template += '<div class="col-sm-12">';
				template += '<div class="form-group">';
				template += '<label>'+ data.remarks_text +'</label>';
				template += '<input type="text" class="form-control" name="remarks" id="remarks" required>';
				template += '</div>';
				template += '</div>';
			}

			if (data.with_days){
				$('#filter_content').css('display', 'block');
				$('#filter_dates').attr('required', 'required');
			} else {
				$('#filter_content').css('display', 'none');
				$('#filter_dates').removeAttr('required');
			}

			$('.content').html(template);
		});
	});


    $('#submitLeaveForm').on('submit', function(e){
    e.preventDefault();
    
    var form = new FormData(this);
    
    Swal.fire({
        title: "Are you sure",
        text: "You want to submit this leave application?",
        icon: "info",
        showCancelButton: true,
        confirmButtonColor: "#3498DB",
        confirmButtonText: "Yes",
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Please wait...',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Submit the form
            $.ajax({
                data        : form,
                url         : "{% url 'leave_application' %}",
                type        : 'POST',
                cache       : false,
                contentType : false,
                processData : false,
                success: function(response) {
                    if (response.data == "success") {
                        Swal.fire({
                          title: "Good job!",
                          text: "This will serve as your tracking no. " + response.tracking_no +". Please wait for the reviewal of your leave application. Thank you.",
                          icon: "success",
                          confirmButtonColor: "#3498DB",
                        }).then((successResult) => {
                            if (successResult.isConfirmed) {
                                $('#submitLeaveForm').trigger('reset');
                                $('.select').val("").change();
                               
                                $('#inclusive_dates, #random_dates').css('display', 'none');
                                $('#apply-leave').modal('hide');
                                $('#leave-table').DataTable().ajax.reload();
                            }
                        });
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 400 && xhr.responseJSON) {
                        let errorData = xhr.responseJSON;
                        if (errorData.error === 'insufficient_credits' || errorData.error === 'no_credits') {
                            Swal.fire({
                                title: "Insufficient Credits",
                                text: errorData.message,
                                icon: "warning",
                                confirmButtonColor: "#3498DB",
                            });
                        } else {
                            Swal.fire({
                                title: "Error",
                                text: errorData.message || "An error occurred while processing your request.",
                                icon: "error",
                                confirmButtonColor: "#3498DB",
                            });
                        }
                    } else {
                        Swal.fire({
                            title: "Error",
                            text: "An error occurred while processing your request. Please try again.",
                            icon: "error",
                            confirmButtonColor: "#3498DB",
                        });
                    }
                }
            });
        }
    });
});
    // $('#leavesubtype').on('change', function() {
    //     if ($(this).val() == "7") {
    //         $('#file_upload_container').show();
    //         $('#file').attr('required', true);
    //     } else {
    //         $('#file_upload_container').hide();
    //         $('#file').removeAttr('required');
    //     }
    // });




function previewFile(fileUrl) {
    document.getElementById('previewFrame').src = fileUrl;
    var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
}


document.getElementById('fullscreenBtn').addEventListener('click', function() {
    const iframe = document.getElementById('previewFrame');
    if (iframe.requestFullscreen) {
        iframe.requestFullscreen();
    } else if (iframe.webkitRequestFullscreen) {
        iframe.webkitRequestFullscreen();
    } else if (iframe.msRequestFullscreen) { 
        iframe.msRequestFullscreen();
    }
});

LeaveCompenSatory()

function LeaveCompenSatory() {
    $('#credits-request-table').DataTable({
        processing: true,
        serverSide: true,
        searching: true, 
        ajax: {
            url: '/api/leave/leave-compensatory/?format=datatables',
            type: 'GET',
            beforeSend: function (request) {
                request.setRequestHeader("Authorization", "Token 82b88a7bdac1ea3868361448927035e93b0dc19d");
            },
        },
        columns: [
            { data: 'action',render: function (data) {
                    return data;
                },'className': 'text-center', 'orderable': 'false','searchable': 'false' 
            },
            { 'data': 'tracking_number','className': 'text-center','name':'compen_tracking',
                render: function (data) {
                    return data ? data : 'N/A';
                }
            },

            { 'data': 'file',  
                render: function (data) {
                    return data 
                        ? '<a href="javascript:void(0)" onclick="previewFile(\'' + data + '\')">Compensatory File Attachment</a>' 
                        : 'No file';
                },'className': 'text-center','name':'file_attachement'
            },
            { 'data': 'requester_name', 'className': 'display-none', 'orderable': 'false','searchable': 'false'},
            { 'data': 'uploaded_at', 'className': 'text-center' ,  'orderable': 'false', 'searchable': 'false'},
             { 'data': 'approved_date', 'className': 'text-center' ,  'orderable': 'false', 'searchable': 'false'},
            { 'data': 'admin_remarks', 'className': 'text-center' ,  'orderable': 'false', 'searchable': 'false'},
            { 'data': 'status', 'className': 'text-center', 'searchable': true }
            
        ],
        order: [[4, 'desc']],  
        lengthMenu: [25, 50, 100]
    });

    

 
$(document).on('click', '[data-role="submit"]', function() {
    var id = $(this).data('id');
    var button = $(this);

    Swal.fire({
        title: 'Are you sure?',
        text: "Once submitted, you cannot edit this compensatory request.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, submit it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            button.html('<i class="fa fa-spinner fa-spin"></i> Submitting...').prop('disabled', true);

            $.ajax({
                url: "{% url 'submit_compensatory' %}",
                type: 'POST',
                data: {
                    'id': id,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Submitted!',
                            text: response.msg,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        $('#credits-request-table').DataTable().ajax.reload();
                    } else {
                        Swal.fire('Error', response.msg, 'error');
                        button.html('Submit').prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire('Error', 'Error submitting request: ' + error, 'error');
                    button.html('Submit').prop('disabled', false);
                }
            });
        }
    });
});


    $(document).on('click', 'a[data-role=cancel-leave]', function() {
    var id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "You want to cancel this request for leave?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#DD6B55",
        confirmButtonText: "Yes",
        input: 'textarea',
        inputPlaceholder: 'Please provide a reason for cancellation...',
        inputAttributes: {
            'aria-label': 'Enter your remarks here'
        },
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        preConfirm: function (remarks) {
            return $.ajax({
                data: {
                    id: id,
                    remarks: remarks
                },
                url: '{% url "cancel_leave" %}',
                type: 'POST',
                dataType: 'json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    return response;
                },
                error: function(xhr, status, error) {
                    Swal.showValidationMessage(
                        `Request failed: ${error}`
                    );
                }
            });
        }
    }).then(function (result) {
        if (result.isConfirmed && result.value && result.value.data == "success") {
            Swal.fire({
                title: "Good job!",
                html: "You have successfully cancelled your request for leave.",
                icon: "success",
                confirmButtonColor: "#3498DB",
                allowOutsideClick: false,
            }).then(() => {
                $('#leave-table').DataTable().ajax.reload();
            });
        }
    });
});


$(document).on('click', 'a[data-role=cancel-compen]', function() {
    var id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "You want to cancel this compensatory request?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#DD6B55",
        confirmButtonText: "Yes",
        input: 'textarea',
        inputPlaceholder: 'Please provide a reason for cancellation...',
        inputAttributes: {
            'aria-label': 'Enter your remarks here'
        },
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        preConfirm: function (remarks) {
            return $.ajax({
                data: {
                    id: id,
                    remarks: remarks
                },
                url: '{% url "cancel_compen_credits" %}',
                type: 'POST',
                dataType: 'json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    return response;
                },
                error: function(xhr, status, error) {
                    Swal.showValidationMessage(
                        `Request failed: ${error}`
                    );
                }
            });
        }
    }).then(function (result) {
        if (result.isConfirmed && result.value && result.value.data == "success") {
            Swal.fire({
                title: "Good job!",
                html: "You have successfully cancelled your compensatory request.",
                icon: "success",
                confirmButtonColor: "#3498DB",
                allowOutsideClick: false,
            }).then(() => {
                $('#credits-request-table').DataTable().ajax.reload();
            });
        }
    });
});

    $(document).on('click', '[data-role="delete"]', function() {
    var id = $(this).data('id');

    Swal.fire({
        title: 'Are you sure?',
        text: "This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post({
                data: {
                    id: id,
                },
                url: "{% url 'delete_compen_credits' %}",
                success: function(response) {
                    if (response.data) {
                        $('#credits-request-table').DataTable().ajax.reload(null, false);
                        Swal.fire(
                            'Deleted!',
                            'The compensatory credit has been deleted.',
                            'success'
                        );
                    } else {
                        Swal.fire(
                            'Error!',
                            'Something went wrong while deleting.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'Unable to connect to the server.',
                        'error'
                    );
                }
            });
        }
    });
});


}

$('#submitCreditsForm').on('submit', function(e) {
    e.preventDefault();
    
    var form = new FormData(this);

    Swal.fire({
        title: "Are you sure?",
        text: "You want to submit this compensatory credit request?",
        icon: "info",
        showCancelButton: true,
        confirmButtonColor: "#3498DB",
        confirmButtonText: "Yes",
        closeOnConfirm: false,
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        preConfirm: function () {
            return $.ajax({
                url: "{% url 'compensatory-request' %}",
                type: 'POST',
                data: form,
                cache: false,
                contentType: false,
                processData: false,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    return response;
                },
                error: function(xhr, status, error) {
                    throw new Error('AJAX failed: ' + error);
                }
            });
        }
    }).then(function (result) {
        if (result.value && result.value.status === "success") {
            Swal.fire({
                title: "Good job!",
                text: result.value.msg || "Compensatory credit request submitted successfully!",
                icon: "success",
                confirmButtonColor: "#3498DB",
            }).then((confirmResult) => {
                if (confirmResult.isConfirmed) {
                    $('#submitCreditsForm')[0].reset();
                    $('#credits-request').modal('hide');
                    
                    if ($.fn.DataTable.isDataTable('#credits-request-table')) {
                        $('#credits-request-table').DataTable().ajax.reload(null, false);
                    }
                }
            });
        } else {
            Swal.fire("Error", result.value?.msg || "An unexpected error occurred", "error");
        }
    }).catch(function(error) {
        Swal.fire("Error", "Something went wrong. Please try again.", "error");
    });
});

	$(document).on('click', 'a[data-role=edit]', function(){
		var tracking_no = $(this).data('filter');
		
		$('#edit-content').load("/personnel/requests/leave/edit/" + $(this).data('id'), function(){
			$('#edit-leave .modal-title').text('EDIT LEAVE APPLICATION: ' + tracking_no);
			$('#edit-leave').modal('show');
		});
	});



    $(document).ready(function() {
        $('#approval-table').DataTable({
            serverSide: false,
            processing: true,
            deferRender: true,
            order: [[3, 'desc']],
            lengthMenu: [25, 50, 100],
            ajax: {
                url: '/api/leave/for-approval/?employee_id={{ request.session.emp_id }}',
                type: 'GET',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Token 82b88a7bdac1ea3868361448927035e93b0dc19d");
                },
                dataSrc: function (json) {
                    return json.results;
                }
            },
            columns: [
                {
                    data: 'id',
                    render: function (data, type, row) {
                        let template = '';
                        const status = row.status;
                        
                        if (status === 0) {
                            template += `<a href="/leave/requests/print/${row.leave_id}?signatory_id={% getHash data %}" target="_blank" class="btn-approve-page">Review Request</a>`;
                            // template += `<a href="/leave/requests/print/${row.leave_id}?signatory_id=${data}" target="_blank" class="btn-approve-page">Approve</a>`;
                        }
                        return template;
                    },
                    searchable: false
                },
                { data: 'leavesubtype_name', className: 'text-center' },
                { 
                    data: 'tracking_no', 
                    className: 'text-center',
                    render: function (data, type, row) {
                        return `<a href='/leave/requests/print/${row.leave_id}?signatory_id={% getHash data %}' target='_blank'>${data}</a>`;
                    }
                },
                { data: 'inclusive_date', className: 'text-center' },
                { data: 'requested_by', className: 'text-center' },
                { data: 'date_of_filing', className: 'text-center' },
                { data: 'get_status', className: 'text-center' }
            ]
        });


        
$(document).ready(function () {
    $("#trackingNo").on("keyup", function () {
        let query = $(this).val();

        if (query.length > 0) {
            $.ajax({
                url: "{% url 'get_tracking_numbers' %}",
                data: { search: query },
                success: function (response) {
                    let list = $("#trackingList");
                    list.empty();

                    if (response.applications.length > 0) {
                        response.applications.forEach(function (app) {
                            list.append(
                                `<li class="list-group-item tracking-item">
                                    <strong>${app.tracking_no}</strong><br>
                                    ${app.inclusive} | ${app.status}
                                </li>`
                            );
                        });
                        list.show();
                    } else {
                        list.hide();
                    }
                },
                error: function() {
                    console.log("AJAX error");
                }
            });
        } else {
            $("#trackingList").hide();
        }
    });

    $(document).on("click", ".tracking-item", function () {
        let trackingNo = $(this).find("strong").text();
        $("#trackingNo").val(trackingNo);
        $("#trackingList").hide();
    });

    $(document).click(function (e) {
        if (!$(e.target).closest('#trackingNo, #trackingList').length) {
            $("#trackingList").hide();
        }
    });
});



function calculateProgress(steps) {
    if (!steps || steps.length === 0) return 0;
    let approved = steps.filter(s => s.status === 1).length;
    return (approved / steps.length) * 100;
}

    document.getElementById("btn-TrackLeave").addEventListener("click", function () {
    const trackingNo = document.getElementById("trackingNo").value.trim();

    if (!trackingNo) {
        Swal.fire({
            icon: "warning",
            title: "Missing Tracking No.",
            text: "Please enter a tracking number."
        });
        return;
    }
        fetch(`/api/leave/search-leave/?tracking_no=${encodeURIComponent(trackingNo)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                Swal.fire({
                    icon: "error",
                    title: "Not Found",
                    text: data.error
                });
                return;
            }

            const steps = data.steps || [];

            let stepsHtml = `
                <div class="tracker d-flex justify-content-between align-items-start">
                    <div class="progress w-100">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${calculateProgress(steps)}%;"></div>
                    </div>
            `;

            steps.forEach((step, index) => {
                let circleClass, iconHtml, numClass;

                if (step.status === 1) {
                    circleClass = "bg-success text-white";
                    iconHtml = `<i class="bi bi-check-lg"></i>`;
                    numClass = "num-success";
                } else if (step.status === 2) {
                    circleClass = "bg-danger text-white";
                    iconHtml = `<i class="bi bi-x-lg"></i>`;
                    numClass = "num-danger";
                } else {
                    circleClass = "bg-light border text-secondary";
                    iconHtml = `<i class="bi bi-clock"></i>`;
                    numClass = "num-pending";
                }

                stepsHtml += `
                    <div class="step text-center">
                        <div class="step-head">
                            <div class="step-number ${numClass}">${index + 1}</div>
                            <div class="circle ${circleClass}">${iconHtml}</div>
                        </div>

                        <p class="fw-bold step-label">${step.label}</p>
                        <small class="step-info">
                            ${step.name || ""}
                            ${step.date ? "<br>" + step.date : ""}
                        </small>
                    </div>
                `;
            });

            stepsHtml += `</div>`;
            document.getElementById("trackingResult").innerHTML = stepsHtml;
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Something went wrong. Please try again."
            });
        });
    });


    


   

    $(document).on('click', 'a[data-role=set-signatories]', function () {
        var id = $(this).data('id');
        var url = `/leave/request/signatories/${id}/1`;

        $('#set-signatories-content-leave').load(url, function () {
            $('#set_signatories_modal').modal('show');

            $(".filter_employee_signatories_to").typeahead({
                source: function (query, process) {
                    return $.get({
                        url: '{% url "filter_employee" %}',
                        data: { query: query },
                        datatype: 'json',
                        success: function (data) {
                            return process(data);
                        }
                    });
                },
                highlight: true,
            });
            

            $('#setSignatoriesFormLeave').on('submit', function (e) {
                e.preventDefault();
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    beforeSend: function () {
                        $('#btn-set-signatories-save-changes').prop('disabled', true);
                    },
                    success: function (response) {
                        if (response.success) {
                            $('#set_signatories_modal').modal('hide');
                            $('#approval-table').DataTable().ajax.reload();
                            Swal.fire({
                                icon: 'success',
                                title: 'Signatories Confirmed!',
                                text: 'The leave request is now in the "For Approval" tab.',
                                timer: 5000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'info',
                                title: 'Already on Process',
                                html: response.message,
                                timer: 5000,
                                showConfirmButton: false
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Something went wrong while saving signatories.',
                            showConfirmButton: true
                        });
                    },
                    complete: function () {
                        $('#btn-set-signatories-save-changes').prop('disabled', false);
                    }
                });
            });

        });
    });

});

        globalInitialization();
        setInterval(globalInitialization, 5000);
        function globalInitialization(){
            $.get({
                url: '{% url "get_leave_totals" %}',
                success: function(response){
                    $('#total-leave-for-approval').text(response.for_approval);
                    $('#total-leave-application').text(response.total_leave_application);

                    
                }
            });
        }

	$(document).on('click', 'a[data-role=attachment]', function(){
    var id = $(this).data('id');
    $('#leave-attachment-content').load("/backend/leave-request/attachment/" + id, function(response){
        var fileUploaded = $(response).find('#file-uploaded').val();
        if (fileUploaded) {
            $.ajax({
                url: "/backend/leave-request/attachment/" + id,
                type: 'POST',
                data: {'pk': id},
                success: function(response) {
                    var file_name = response.file_name;
                    console.log("File uploaded:", file_name);
                    $('#leave-table').DataTable().ajax.reload(null, false); 
                }
            });
        }
        $('#leave-attachment-modal').modal('show');
    });
});

document.getElementById("fundsourceSelect").addEventListener("change", function() {
    let filter = this.value.toLowerCase();
    let items = document.querySelectorAll("#fundsourceList .list-group-item");

    items.forEach(item => {
        let text = item.textContent.toLowerCase();
        item.style.display = (filter === "" || text.includes(filter)) ? "" : "none";
    });
});


</script>
{% endblock %}