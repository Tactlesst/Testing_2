{% load tags %}
{% block style %}

<style>
    #table-wes tbody tr:hover {
        background-color: white !important;
    }

    table {
        width: 100%;
        table-layout: fixed;
    }

    .bootstrap-select .dropdown-menu .inner {
        white-space: normal !important;
        word-wrap: break-word !important;
        max-width: 100% !important;
    }

    .bootstrap-select .dropdown-menu li a {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        display: block;
        padding: 0.5rem;
    }

    .modal-backdrop {
        display: none;
    }
</style>

{% endblock %}

{% if user|check_permission:'edit_employee' or user|check_permission:'superadmin'%}

<div class="row mb-3">
    <div class="col-lg-12">
        <div class="pull-left">
            <h3 class="bold m-0">Employee Movement</h3>
            <small>Update employee movement below.</small>
        </div>
        <div class="pull-right">
            <button id="saveJobMovement" class="btn btn-info">Save changes</button>
        </div>
    </div>
</div>

<div class="ibox-content">
    <form id="jobMovementForm">
        <div class="row">
            <!-- Old Position -->
            <div class="col-md-4">
                <label>Old Position</label>
                <input type="text" id="current_position" class="form-control" value="{{ employee.position.name }}"
                    readonly>
            </div>

            <!-- New Position -->
            <div class="col-md-4">
                <label>New Position</label>
                <select id="new_position" class="form-control selectpicker w-100" data-live-search="true"
                    data-width="100%">
                    <option value="" disabled selected>Select New Position</option>
                    {% for position in positions %}
                    <option value="{{ position.id }}" data-name="{{ position.name }}">{{ position.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Employment Status -->
            <div class="col-md-4">
                <label>Employment Status</label>
                <select id="emp_status" class="form-control selectpicker w-100" data-live-search="true"
                    data-width="100%">
                    <option value="" disabled selected>Employment Status</option>
                    {% for status in employment_statuses %}
                    <option value="{{ status.id }}">{{ status.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <!-- Salary Rate -->
            <div class="col-md-4">
                <label>Salary Rate</label>
                <input type="number" id="salary_rate" class="form-control" placeholder="ex. 29000" required>
            </div>

            <!-- Salary Grade -->
            <div class="col-md-4">
                <label>Salary Grade</label>
                <select id="sg_step" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected>Select SG</option>
                    {% for i in salary_grades %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Government Service -->
            <div class="col-md-4">
                <label>Government Service</label>
                <select id="govt_service" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected>Select</option>
                    <option value="1">Yes</option>
                    <option value="2">No</option>
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <!-- Fund Source -->
            <div class="col-md-4">
                <label>Fund Source</label>
                <select id="fundsource" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected>Select Fund Source</option>
                    {% for fund in fundsources %}
                    <option value="{{ fund.id }}">{{ fund.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Area of Assignment -->
            <div class="col-md-4">
                <label>Area of Assignment</label>
                <select id="aoa" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected>Select Area of Assignment</option>
                    {% for area in aoa %}
                    <option value="{{ area.id }}">
                        <!-- {% if employee.aoa_id == area.id %}selected{% endif %} -->
                        {{ area.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>


            <!-- Section -->
            <div class="col-md-4">
                <label>Section</label>
                <select id="section" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected>Select Section</option>
                    {% for sec in section %}
                    <option value="{{ sec.id }}">
                        {{ sec.sec_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mt-3">
            <!-- Reason -->
            <div class="col-md-4">
                <label>Reason</label>
                <select id="reason" class="form-control selectpicker w-100" data-live-search="true" required>
                    <option value="" disabled selected hidden>Select Reason</option>
                    <option value="1">Promotion</option>
                    <option value="2">Demotion</option>
                    <option value="3">Transferred to other program</option>
                    <option value="4">Transfer</option>
                    <option value="5">Reemployment</option>
                    <option value="6">Reappointment</option>
                    <option value="7">Original</option>

                </select>
            </div>

            <!-- Step Increment -->
            <div class="col-md-4">
                <label>Step Increment</label>
                <select id="step_inc" class="form-control selectpicker w-100" data-live-search="true">
                    <option value="">Step Increment</option>
                    {% for increment in stepinc %}
                    <option value="{{ increment.id }}">{{ increment.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Starting Date -->
            <div class="col-md-4">
                <label>Starting Date</label>
                <input type="date" id="we_from" class="form-control">
            </div>
        </div>

    </form>
</div>
{% else %}
<p>You don't have permission to access the Job Movement.</p>
{% endif %}


<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        $('.selectpicker').selectpicker();
    });

    $("#saveJobMovement").on("click", function () {
        Swal.fire({
            title: "Confirm Save",
            text: "Are you sure you want to save the changes?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, save it!"
        }).then((result) => {
            if (result.isConfirmed) {
                saveJobMovement();
            }
        });
    });

    function saveJobMovement() {
        let currentPosition = $("#current_position").val();
        let newPosition = $("#new_position").val();
        let empStatus = $("#emp_status").val();
        let govtService = $("#govt_service").val();
        let fundSource = $("#fundsource").val();
        let aOa = $("#aoa").val();
        let seCtions = $("#section").val();
        let reAson = $("#reason").val();
        let stepInc = $("#step_inc").val();
        let salaryRate = $("#salary_rate").val();
        let salaryGrade = $("#sg_step").val();
        let employeeId = "{{ employee.pi_id }}";

        if (!newPosition || !empStatus) {
            Swal.fire("Warning", "Please fill all required fields.", "warning");
            return;
        }

        let requestData = {
            current_position: currentPosition,
            new_position_id: newPosition,
            emp_status: empStatus,
            govt_service: govtService,
            fundsource: fundSource,
            aoa: aOa,
            section: seCtions,
            reason: reAson,
            step_inc: stepInc,
            salary_rate: salaryRate,
            sg_step: salaryGrade
        };

        let weFrom = $("#we_from").val();
        if (weFrom) requestData.we_from = weFrom;

        $.ajax({
            url: "{% url 'backend-job-movement' employee.pi_id %}",
            type: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            data: requestData,
            success: function (response) {
                Swal.fire("Success!", "Job movement updated successfully!", "success").then(() => {
                    location.reload();
                });
            },
            error: function (error) {
                console.log(error);
                Swal.fire("Error!", "Failed to update job movement.", "error");
            }
        });
    }
</script>