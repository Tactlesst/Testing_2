{% extends 'layout.html' %}
{% load tags %}
{% load frontend_tags %}
{% load static %}
{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
<style>
    input.file {
        border: none;
    }
    .tab-content {
        margin-top: 20px;
    }
    
    #admin-credits-request-table {
    table-layout: fixed;
    width: 100% !important;
    }
   
</style>
{% endblock %}

{% block content %}

<div class="container-fluid">
    <div class="row px-3 pt-3">
        <div class="col-lg-8">
            <h1 class="font-weight-bold">Leave Compensatory Requests</h1>
            <ol class="breadcrumb bg-transparent p-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'backend-dashboard' %}">Home</a>
                </li>
                <li class="breadcrumb-item">
                    Admin
                </li>
                <li class="breadcrumb-item">
                    Leave Management
                </li>
                <li class="breadcrumb-item active">
                    <strong>Compensatory Requests</strong>
                </li>
            </ol>
        </div>
    </div>
    <br>
    

    <div class="row px-4">
        <div class="col-9">
            <div class="card card-info card-outline">
                <div class="card-body">   
                   <div class="table-responsive">
                        <table id="admin-credits-request-table" class="table table-bordered table-hover" style="width:100%">
                            <thead class="thead-light">
                                <tr>
                                    <th class="text-center" width="15%">ACTION</th>
                                    <th class="text-center" width="12%">TRACKING NO</th>
                                    <th class="text-center" width="18%">REQUESTER NAME</th>
                                    <th class="text-center" width="12%">ATTACHMENT</th>
                                    <th class="text-center" width="20%">DATE SUBMITTED</th>
                                    <th class="text-center" width="18%">FUND SOURCE</th>
                                    <th class="text-center" width="18%">AREA OF ASSIGNMENT</th>
                                    <th class="text-center" width="18%">APPROVED DATE</th>
                                    <th class="text-center" width="10%">STATUS</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-3">
            <div class="card">
                <div class="card-header bg-info d-flex justify-content-between align-items-center">
                    <h3 class="card-title font-weight-bold mb-0">FILTER</h3>
                </div>

                <div class="card-body">
                    <label for="fundsourceSelect" class="form-label fw-bold mb-2">Select Fundsource</label>
                    <select id="fundsourceSelect" class="form-control form-select mb-3">
                        <option value="">All Fundsource</option>
                        {% for row in fundsources %}
                            <option value="{{ row.id }}">{{ row.name }}</option>
                        {% endfor %}
                    </select>

                    <label for="aoaSelect" class="form-label fw-bold mb-2">Select Area of Assignment</label>
                    <select id="aoaSelect" class="form-control form-select mb-3">
                        <option value="">All Area of Assignment</option>
                        {% for row in aoa %}
                            <option value="{{ row.id }}">{{ row.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div> 
       </div>
    </div>
       



<div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info d-flex justify-content-between align-items-center">
        <h3 class="modal-title">Preview Attachment File</h3>
        <div>
          <button type="button" class="btn btn-sm btn-secondary me-2" id="fullscreenBtn" title="Fullscreen">
            â›¶
          </button>
			<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        </div>
      </div>
      <div class="modal-body p-0">
        <iframe id="previewFrame" src="" style="width:100%; height:70vh;" frameborder="0"></iframe>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="compensatoryModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-md " role="document">
    <div class="modal-content">
      <div class="modal-header bg-info">
        <h3 class="modal-title">Add Compensatory Credits</h3>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="compensatoryForm">
          <input type="hidden" name="request_id">
          <input type="hidden" name="leave_type" value="4">
          <div class="form-group">
            <label>Credits Amount</label>
            <input type="number" step="0.5" min="0" class="form-control" name="credits" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
			<button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <button type="button" class="btn btn-info" id="saveCompensatory">Confirm</button>
      </div>
    </div>
  </div>
</div>


]{% csrf_token %}
{% endblock %}

{% block script %}
<script src="{% static 'js/app.js' %}"></script>
<script type="text/javascript">
    
    
$('#fundsourceSelect').on('change', function () {
    let selectedFundsource = $(this).val(); 
    AdminLeaveCompensatory(selectedFundsource);   
});

    function AdminLeaveCompensatory(fund_source = "") {
        $('#admin-credits-request-table').DataTable({
            processing: true,
            serverSide: true,
            searching: true,
            responsive: false,  
            scrollX: true,  
            scrollCollapse: true,
             
            ajax: {
                url: '/api/leave/admin-leave-compensatory/?format=datatables',
                type: 'GET',
                data: {
                fund_source: fund_source   
            },
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Token 82b88a7bdac1ea3868361448927035e93b0dc19d");
                },
            },

            "columnDefs": [
                { "orderable": false, "targets": [0,4] },
                { "orderable": true, "targets": [1, 2, 3, 5] }
            ],
            columns: [
                { 
                    data: 'admin_action','orderable':'false','searchable':'false',
                    render: function (data) {
                        return data;
                    },
                    className: 'text-center',
                    orderable: false
                },
                { data: 'tracking_number',className: 'text-center','name':'compen_tracking','searchable':'true',
                    render: function (data) {
                        return data ? data : 'N/A';
                    }
                },
                {  data: 'requester_name', className: 'text-center','name':'requester.pi.user.get_fullname','searchable':'false'},
                {
                    data: 'file',
                    render: function (data) {
                        return data 
                            ? `<a href="javascript:void(0)" onclick="previewFile('${data}')">Compensatory File Attachment</a>` 
                            : 'No file';
                    },
                    className: 'text-center','searchable':'false',
                },
                { data: 'uploaded_at', className: 'text-center','searchable':'false' },
                { data: 'fund_source',className:'text-center','name':'requester.fundsource.name','searchable':'false' },
                { data: 'aoa',className:'text-center','name':'requester.aoa.name','searchable':'false' },
                { data: 'approved_date', className: 'text-center' },
                { data: 'status', className: 'text-center', searchable: true }
            ],
            order: [[5, 'desc']],  
            lengthMenu: [10, 25, 50, 100],
            pageLength: 25,
           
        });
    }

function previewFile(fileUrl) {
    document.getElementById('previewFrame').src = fileUrl;
    var previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
}


document.getElementById('fullscreenBtn').addEventListener('click', function() {
    const iframe = document.getElementById('previewFrame');
    if (iframe.requestFullscreen) {
        iframe.requestFullscreen();
    } else if (iframe.webkitRequestFullscreen) {
        iframe.webkitRequestFullscreen();
    } else if (iframe.msRequestFullscreen) { 
        iframe.msRequestFullscreen();
    }
});

$(document).on('click', '[data-role="approve"]', function() {
    var id = $(this).data('id');
    $('#compensatoryModal input[name="request_id"]').val(id);
    $('#compensatoryModal input[name="leave_type"]').val(4);
    $('#compensatoryModal').modal('show');
});


$(document).on('click', '#saveCompensatory', function() {
    var formData = $('#compensatoryForm').serialize();

    $.ajax({
    url: '{% url "add_compensatory_credits" %}',  
    type: 'POST',
    data: formData + '&csrfmiddlewaretoken=' + $('[name=csrfmiddlewaretoken]').val(),
        success: function(response) {
            if (response.status === 'success') {
                $('#compensatoryModal').modal('hide');
                Swal.fire('Success!', response.msg, 'success');
                $('#admin-credits-request-table').DataTable().ajax.reload(null, false);
            } else {
                Swal.fire('Error!', response.msg, 'error');
            }
        },
        error: function(xhr) {
            Swal.fire('Error!', 'Failed to save credits', 'error');
        }
    });
});

$(document).on('click', '[data-role="reject"]', function() {
    var id = $(this).data('id');

    Swal.fire({
        title: 'Reject Request',
        text: "Please provide a reason for rejection:",
        input: 'textarea',
        inputPlaceholder: 'Enter your remarks here...',
        inputAttributes: {
            'aria-label': 'Type your remarks here'
        },
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Reject',
        preConfirm: (remarks) => {
            if (!remarks) {
                Swal.showValidationMessage('Remarks are required!')
            }
            return remarks;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.post({
                url: "{% url 'reject_compen_credits' %}",
                data: {
                    id: id,
                    remarks: result.value,  
                },
                success: function(response) {
                    if (response.data) {
                        $('#admin-credits-request-table').DataTable().ajax.reload(null, false);
                        Swal.fire(
                            'Rejected!',
                            'The compensatory credit has been rejected with remarks.',
                            'success'
                        );
                    } else {
                        Swal.fire(
                            'Error!',
                            'Something went wrong while rejecting.',
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'Unable to connect to the server.',
                        'error'
                    );
                }
            });
        }
    });
});


    $(document).on('click', '[data-role="view"]', function() {
        var id = $(this).data('id');
        alert('View functionality - ID: ' + id);
    });
    $(document).ready(function() {
        AdminLeaveCompensatory();
    });
</script>
{% endblock %}