{% extends 'layout.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h3 class="mb-0">Individual Development Plan (LDI Plan)</h3>
            <small class="text-muted">{% if plan.id %}Edit your selected plan{% else %}Create a new plan{% endif %}</small>
        </div>
        <div>
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'ldi_list' %}">Back</a>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            Create / Edit LDI Plan
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <div class="form-group">
                    <label>Training Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="training_title" value="{{ plan.training_title }}" required>
                </div>

                <!-- Training Category, Quarter, Year -->
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Training Category <span class="text-danger">*</span></label>
                        <select class="form-control" name="category" id="category-select" required>
                            {% for c in categories %}
                                <option value="{{ c }}" {% if plan.category == c %}selected{% endif %}>{{ c|upper }}</option>
                            {% endfor %}
                            <option value="_new">+ Propose New Category</option>
                        </select>
                        <input type="text" class="form-control mt-2" name="new_category" id="new-category-input" placeholder="Enter new category (approval required)" style="display:none;">
                    </div>

                    <div class="form-group col-md-3">
                        <label>Quarter <span class="text-danger">*</span></label>
                        <select class="form-control" name="quarter">
                            <option value="Q1" {% if plan.quarter == "Q1" %}selected{% endif %}>1st Quarter</option>
                            <option value="Q2" {% if plan.quarter == "Q2" %}selected{% endif %}>2nd Quarter</option>
                            <option value="Q3" {% if plan.quarter == "Q3" %}selected{% endif %}>3rd Quarter</option>
                            <option value="Q4" {% if plan.quarter == "Q4" %}selected{% endif %}>4th Quarter</option>
                        </select>
                    </div>

                    <div class="form-group col-md-3">
                        <label>Year <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="year" value="{{ plan.year|default:current_year }}" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="multi-quarter-toggle" name="multi_quarter" value="1">
                        <label class="custom-control-label" for="multi-quarter-toggle">Create this plan for multiple quarters</label>
                    </div>
                </div>

                <div class="form-group" id="multi-quarter-options" style="display:none;">
                    <label>Select additional quarters</label>
                    <div class="d-flex flex-wrap" style="gap: 12px;">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="q1" name="quarters" value="Q1">
                            <label class="custom-control-label" for="q1">Q1</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="q2" name="quarters" value="Q2">
                            <label class="custom-control-label" for="q2">Q2</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="q3" name="quarters" value="Q3">
                            <label class="custom-control-label" for="q3">Q3</label>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="q4" name="quarters" value="Q4">
                            <label class="custom-control-label" for="q4">Q4</label>
                        </div>
                    </div>
                </div>

                <!-- Activities -->
                <div class="form-group">
                    <label>Proposed LDI / Activities <span class="text-danger">*</span></label>
                    <textarea class="form-control" name="activities" rows="3" required>{% if plan.activities %}{% for act in plan.activities %}{{ act }}
{% endfor %}{% endif %}</textarea>
                </div>

                <!-- Proposed Date, Participants, Budget -->
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Proposed Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="proposed_date" value="{{ plan.proposed_date|default:today }}" required>
                    </div>

                    <div class="form-group col-md-4">
                        <label>Target Participants <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="participants" value="{{ plan.participants }}" required>
                    </div>

                    <div class="form-group col-md-4">
                        <label>Budget <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="budget" value="{{ plan.budget }}" required inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g,'')">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Start Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" name="start_time" value="{{ plan.start_time|default:'08:00' }}" required>
                    </div>

                    <div class="form-group col-md-6">
                        <label>End Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" name="end_time" value="{{ plan.end_time|default:'17:00' }}" required>
                    </div>
                </div>

                <!-- Competencies -->
                <div class="form-group">
                    <label>Target Competencies <span class="text-danger">*</span></label>
                    <textarea class="form-control" name="competencies" rows="3" required>{{ plan.competencies }}</textarea>
                </div>

                <!-- Aim -->
                <div class="form-group">
                    <label>Aim <span class="text-danger">*</span></label>
                    <textarea class="form-control" name="aim" rows="3" required>{{ plan.aim }}</textarea>
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-info">Save LDI Plan</button>
                </div>

            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category-select');
    const newCategoryInput = document.getElementById('new-category-input');

    const quarterSelect = document.querySelector('select[name="quarter"]');
    const multiToggle = document.getElementById('multi-quarter-toggle');
    const multiOptions = document.getElementById('multi-quarter-options');
    const quarterCheckboxes = multiOptions ? multiOptions.querySelectorAll('input[name="quarters"]') : [];

    categorySelect.addEventListener('change', function() {
        if (this.value === '_new') {
            newCategoryInput.style.display = 'block';
            newCategoryInput.required = true;
        } else {
            newCategoryInput.style.display = 'none';
            newCategoryInput.required = false;
        }
    });

    function syncMultiQuarterVisibility() {
        if (!multiToggle || !multiOptions) return;

        if (multiToggle.checked) {
            multiOptions.style.display = 'block';
            if (quarterSelect) {
                const selectedQuarter = quarterSelect.value;
                quarterCheckboxes.forEach(cb => {
                    if (cb.value === selectedQuarter) cb.checked = true;
                });
            }
        } else {
            multiOptions.style.display = 'none';
            quarterCheckboxes.forEach(cb => cb.checked = false);
        }
    }

    if (quarterSelect) {
        quarterSelect.addEventListener('change', function() {
            if (!multiToggle || !multiToggle.checked) return;
            const selectedQuarter = quarterSelect.value;
            quarterCheckboxes.forEach(cb => {
                cb.checked = (cb.value === selectedQuarter) ? true : cb.checked;
            });
        });
    }

    if (multiToggle) {
        multiToggle.addEventListener('change', syncMultiQuarterVisibility);
        syncMultiQuarterVisibility();
    }
});
</script>
{% endblock %}
