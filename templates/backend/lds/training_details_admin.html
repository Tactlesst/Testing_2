{% load tags %}
{% load frontend_tags %}
{% load crispy_forms_tags %}
<style>
    .input-group > .select2-container {
        flex: 1 1 auto;
        width: 1% !important;
    }

    .select2-selection__rendered .ldi-plan-info-toggle {
        display: inline-block;
        margin-right: 6px;
        vertical-align: middle;
    }
    
    #rejectModal {
        z-index: 1050 !important;
    }
    
    .modal-backdrop.show {
        z-index: 1049 !important;
    }



    .status-badge {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .status-badge.approved {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-badge.rejected {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>

<div class="modal-body">
    <div class="row mb-3">
        <div class="col-md-12">
            <!-- Status Display -->
            <div>
                {% if training.rrso_status == -1 or training.rso_status == -1 %}
                    <span class="status-badge rejected">✗ Training Rejected</span>
                {% else %}
                    {% if training.rrso_status == 1 %}
                        <span class="status-badge approved">✓ Training Approved</span>
                    {% else %}
                        <span class="status-badge pending">⏳ Training Pending Approval</span>
                    {% endif %}

                    {% if training.rso_status == 1 %}
                        <span class="status-badge approved">✓ RSO Approved</span>
                    {% elif training.rrso_status == 1 %}
                        <span class="status-badge pending">⏳ RSO Pending Approval</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <ul class="nav nav-tabs" id="tabUL">
            <li class="nav-item"><a class="nav-link text-dark active" data-toggle="tab" href="#details">Details</a></li>
            <li class="nav-item"><a class="nav-link text-dark" data-toggle="tab" href="#ldi-plan">LDI Plan</a></li>
            <li class="nav-item"><a class="nav-link text-dark" data-toggle="tab" href="#participants">Participants</a></li>
            <li class="nav-item"><a class="nav-link text-dark" data-toggle="tab" href="#facilitators">Facilitators</a></li>
        </ul>
        <div class="tab-content" style="border: 0px !important;">
            <!-- Details Tab -->
            <div id="details" class="tab-pane active">
                <div class="border p-3">
                    <!-- READ-ONLY Details Form -->
                    <div class="form-group">
                        <label>Training Title</label>
                        <input type="text" class="form-control" value="{{ training.training.tt_name }}" readonly>
                    </div>

                    <div class="form-group">
                        <label>Venue</label>
                        <textarea class="form-control" rows="3" readonly>{{ training.venue }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-lg-5">
                            <label>Start Date</label>
                            <input type="date" class="form-control" value="{{ training.start_date|date:'Y-m-d' }}" readonly>
                        </div>
                        <div class="col-lg-7">
                            <label>End Date</label>
                            <input type="date" class="form-control" value="{{ training.end_date|date:'Y-m-d' }}" readonly>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6">
                            <label>Time Start</label>
                            <input type="time" class="form-control" value="{{ training.start_date|date:'H:i' }}" readonly>
                        </div>
                        <div class="col-lg-6">
                            <label>Time End</label>
                            <input type="time" class="form-control" value="{{ training.end_date|date:'H:i' }}" readonly>
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label>Online Platform?</label>
                        <input type="checkbox" {% if training.is_online_platform %}checked{% endif %} disabled>
                    </div>

                    <hr style="margin-right:-15px; margin-left:-15px; margin-top:25px;">

                    <!-- Admin Action Buttons Only -->
                    <div class="ibox">
                        <div class="ibox-title bg-primary" style="padding: 12px 15px;">
                            <div class="d-flex align-items-center justify-content-between" style="gap: 12px;">
                                <h5 class="mb-0">ADMIN ACTIONS</h5>
                            </div>
                        </div>
                        <div class="ibox-content" style="padding: 15px;">
                            <div class="d-flex justify-content-between align-items-start flex-wrap" style="gap: 12px;">
                                <div>
                                    <div class="font-weight-bold">Training Approval (RRSO)</div>
                                    <small class="text-muted">Initial training approval</small>
                                </div>
                                <div class="text-right">
                                    {% if training.rrso_status == -1 %}
                                        <span class="badge badge-danger mb-2">Training Rejected</span>
                                        <div>
                                            <button type="button" class="btn btn-success btn-sm" id="approve-training-btn">
                                                <i class="fas fa-check-circle"></i> Approve
                                            </button>
                                        </div>
                                    {% elif not training.rrso_status %}
                                        <button type="button" class="btn btn-success btn-sm" id="approve-training-btn">
                                            <i class="fas fa-check-circle"></i> Approve
                                        </button>
                                    {% else %}
                                        <span class="badge badge-success">Approved</span>
                                    {% endif %}
                                </div>
                            </div>

                            <hr class="my-3">

                            <div class="d-flex justify-content-between align-items-start flex-wrap" style="gap: 12px;">
                                <div>
                                    <div class="font-weight-bold">RSO Approval</div>
                                    <small class="text-muted">Final approval</small>
                                </div>
                                <div class="text-right">
                                    {% if training.rrso_status == 1 and training.rso_status == 0 or training.rrso_status == 1 and training.rso_status is None %}
                                        <button type="button" class="btn btn-success btn-sm" id="approve-rso-btn">
                                            <i class="fas fa-check-circle"></i> Approve
                                        </button>
                                    {% elif training.rso_status == 1 %}
                                        <span class="badge badge-success">Approved</span>
                                    {% elif training.rso_status == -1 %}
                                        <span class="badge badge-danger mb-2">RSO Rejected</span>
                                        <div>
                                            <button type="button" class="btn btn-success btn-sm" id="approve-rso-btn">
                                                <i class="fas fa-check-circle"></i> Approve
                                            </button>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-secondary">Waiting for RRSO Approval</span>
                                    {% endif %}
                                </div>
                            </div>

                            <hr class="my-3">

                            <div class="d-flex justify-content-between align-items-start flex-wrap" style="gap: 12px;">
                                <div>
                                    <div class="font-weight-bold">Rejection</div>
                                    <small class="text-muted">Reject this request</small>
                                </div>
                                <div class="text-right">
                                    {% if training.rrso_status == 1 and training.rso_status == 1 %}
                                        <span class="badge badge-secondary">Cannot reject - Training fully approved</span>
                                    {% else %}
                                        <button type="button" class="btn btn-danger btn-sm" id="reject-training-btn">
                                            <i class="fas fa-times-circle"></i> Reject
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info Section -->
                    <hr style="margin-right:-15px; margin-left:-15px; margin-top:25px;">
                    <div class="info-section">
                        <h6 class="font-weight-bold">Training Information</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Created By:</strong> {{ training.created_by.pi.user.get_fullname }}</p>
                                <p><strong>Date Created:</strong> {{ training.date_created|date:"F d, Y g:i A" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Last Updated:</strong> {{ training.date_updated|date:"F d, Y g:i A" }}</p>
                                <p><strong>Status:</strong> 
                                    {% if training.rso_status == 1 %}
                                        <span class="badge badge-success">Approved</span>
                                    {% elif training.rrso_status == 1 %}
                                        <span class="badge badge-info">Training Approved</span>
                                    {% else %}
                                        <span class="badge badge-warning">Pending</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LDI Plan Tab -->
            <div id="ldi-plan" class="tab-pane">
                <div class="border p-3">
                    <div id="ldi-plan-content">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin"></i> Loading LDI Plan details...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Tab -->
            <div id="participants" class="tab-pane">
                <div class="border p-3">
                    <div class="tabs-container">
                        <!-- Internal Participants - READ ONLY -->
                        <div class="form-group">
                            <h6 class="font-weight-bold mb-3">Internal Participants</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="lds-internal-participants-table-admin" width="100%">
                                    <thead class="table-info">
                                        <tr>
                                            <th width="30%">EMPLOYEE NAME</th>
                                            <th width="30%">POSITION</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <hr style="margin-right:-15px; margin-left:-15px;">

                        <!-- External Participants - READ ONLY -->
                        <div class="form-group" style="margin-bottom:0px;">
                            <h6 class="font-weight-bold mb-3">External Participants</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="lds-external-participants-table-admin" width="100%">
                                    <thead class="table-info">
                                        <tr>
                                            <th width="30%">PARTICIPANT NAME</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Facilitators Tab -->
            <div id="facilitators" class="tab-pane">
                <div class="border p-3">
                    <!-- Internal Facilitators - READ ONLY -->
                    <h6 class="font-weight-bold mb-3">Internal Facilitators</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="lds-facilitators-table-admin" width="100%">
                            <thead class="table-info">
                                <tr>
                                    <th>EMPLOYEE NAME</th>
                                    <th class="text-center">POSITION</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <hr style="margin-right:-15px; margin-left:-15px;">

                    <!-- External Facilitators - READ ONLY -->
                    <div class="form-group" style="margin-bottom:0px;">
                        <h6 class="font-weight-bold mb-3">External Facilitators</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="lds-external-facilitator-table-admin" width="100%">
                                <thead class="table-info">
                                    <tr>
                                        <th width="30%">FACILITATOR / RESOURCE PERSON NAME</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Footer with Generate Options -->
<div class="modal-footer">
    <div class="dropup btn-group">
        <button type="button" data-toggle="dropdown" class="btn btn-info dropdown-toggle">
            <i class="fas fa-file-download"></i> Generate <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" style="margin-left: -20px !important;">
            {% if training.rrso_status == 1 %}
                <li><a class="dropdown-item" href="{% url 'print_rso' training.id %}" target="_blank">
                    <i class="fas fa-file-pdf"></i> RSO
                </a></li>
            {% endif %}
            <li><a class="dropdown-item" href="{% url 'print_ld_attendance' training.id %}" target="_blank">
                <i class="fas fa-list"></i> Attendance Sheet
            </a></li>
        </ul>
    </div>

    {% if training.rso_status == 1 %}
    <div class="dropup btn-group">
        <button type="button" data-toggle="dropdown" class="btn btn-warning dropdown-toggle">
            <i class="fas fa-certificate"></i> Generate Certificates <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" style="margin-left: -20px !important;">
            <li><a class="dropdown-item" href="{% url 'generate_certificate_of_appearance' training.id %}" target="_blank">
                <i class="fas fa-certificate"></i> Appearance
            </a></li>
            <li><a class="dropdown-item" href="{% url 'generate_certificate_participants' training.id %}" target="_blank">
                <i class="fas fa-users"></i> Participants
            </a></li>
            <li><a class="dropdown-item" href="{% url 'generate_certificate_facilitators' training.id %}" target="_blank">
                <i class="fas fa-chalkboard-user"></i> Facilitators
            </a></li>
        </ul>
    </div>
    {% endif %}

    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
</div>

{% block script %}
<script>
$(document).ready(function(){
    var trainingId = {{ training.id }};
    var trainingTitleId = {{ training.training_id }};

    // Load LDI Plan when tab is clicked
    $('a[href="#ldi-plan"]').on('click', function(){
        var content = $('#ldi-plan-content');
        if(!content.data('loaded')){
            content.load(
                '{% url "ldi_plan_details" 0 %}'.replace('/0/', '/' + trainingTitleId + '/'),
                function(){
                    content.data('loaded', true);
                }
            );
        }
    });

    // LDI Plan Info Toggle (Exclamation Mark)
    $(document).on('click', '.ldi-plan-info-toggle-admin', function(e){
        e.preventDefault();
        e.stopPropagation();

        var trainId = $(this).data('training-id');
        if (!trainId){
            return;
        }

        // Show the LDI Plan tab
        $('#tabUL a[href="#ldi-plan"]').tab('show');

        // Scroll to LDI Plan tab
        $('html, body').animate({
            scrollTop: $('#ldi-plan-content').offset().top - 100
        }, 500);
    });

    // Initialize Select2
    $('#training-id-update-admin').select2({
        width: '100%',
        allowClear: true,
        placeholder: 'Type to search training title..',
        minimumInputLength: 0,
        escapeMarkup: function (markup) { return markup; },
        ajax: {
            url: '{% url "lds_trainingtitle_search" %}',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return data;
            },
            cache: true
        }
    });

    // Load Participants (Internal - type 0)
    function loadInternalParticipants() {
        console.log('Loading internal participants for RSO ID:', trainingId);
        {% getHash 0 as type_pk_0 %}
        {% getHash training.id as rso_pk %}
        $.ajax({
            url: '/api/learning-and-development/participants/?type_pk={{ type_pk_0 }}&rso_pk={{ rso_pk }}&format=json',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                console.log('Internal participants data received:', data);
                var internalRows = '';
                
                if(data.results && data.results.length > 0){
                    $.each(data.results, function(i, row){
                        console.log('Processing internal participant:', row);
                        internalRows += '<tr><td>' + (row.full_name || '') + '</td><td>' + (row.position || '') + '</td></tr>';
                    });
                }
                
                // Update table
                $('#lds-internal-participants-table-admin tbody').html(internalRows || '<tr><td colspan="2" class="text-center">No internal participants</td></tr>');
            },
            error: function(xhr, status, error){
                console.log('Error loading internal participants:', xhr.status, error);
                $('#lds-internal-participants-table-admin tbody').html('<tr><td colspan="2" class="text-center">Error loading participants</td></tr>');
            }
        });
    }

    // Load Participants (External - type 1)
    function loadExternalParticipants() {
        console.log('Loading external participants for RSO ID:', trainingId);
        {% getHash 1 as type_pk_1 %}
        {% getHash training.id as rso_pk %}
        $.ajax({
            url: '/api/learning-and-development/participants/?type_pk={{ type_pk_1 }}&rso_pk={{ rso_pk }}&format=json',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                console.log('External participants data received:', data);
                var externalRows = '';
                
                if(data.results && data.results.length > 0){
                    $.each(data.results, function(i, row){
                        console.log('Processing external participant:', row);
                        externalRows += '<tr><td>' + (row.participants_name || '') + '</td></tr>';
                    });
                }
                
                // Update table
                $('#lds-external-participants-table-admin tbody').html(externalRows || '<tr><td class="text-center">No external participants</td></tr>');
            },
            error: function(xhr, status, error){
                console.log('Error loading external participants:', xhr.status, error);
                $('#lds-external-participants-table-admin tbody').html('<tr><td class="text-center">Error loading participants</td></tr>');
            }
        });
    }

    // Load Facilitators (Internal - is_external = False/0)
    function loadInternalFacilitators() {
        console.log('Loading internal facilitators for RSO ID:', trainingId);
        {% getHash 0 as type_pk_0 %}
        {% getHash training.id as rso_pk %}
        $.ajax({
            url: '/api/learning-and-development/facilitators/?type_pk={{ type_pk_0 }}&rso_pk={{ rso_pk }}&format=json',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                console.log('Internal facilitators data received:', data);
                var internalRows = '';
                
                if(data.results && data.results.length > 0){
                    $.each(data.results, function(i, row){
                        console.log('Processing internal facilitator:', row);
                        internalRows += '<tr><td>' + (row.full_name || '') + '</td><td class="text-center">' + (row.position || '') + '</td></tr>';
                    });
                }
                
                // Update table
                $('#lds-facilitators-table-admin tbody').html(internalRows || '<tr><td colspan="2" class="text-center">No internal facilitators</td></tr>');
            },
            error: function(xhr, status, error){
                console.log('Error loading internal facilitators:', xhr.status, error);
                $('#lds-facilitators-table-admin tbody').html('<tr><td colspan="2" class="text-center">Error loading facilitators</td></tr>');
            }
        });
    }

    // Load Facilitators (External - is_external = True/1)
    function loadExternalFacilitators() {
        console.log('Loading external facilitators for RSO ID:', trainingId);
        {% getHash 1 as type_pk_1 %}
        {% getHash training.id as rso_pk %}
        $.ajax({
            url: '/api/learning-and-development/facilitators/?type_pk={{ type_pk_1 }}&rso_pk={{ rso_pk }}&format=json',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                console.log('External facilitators data received:', data);
                var externalRows = '';
                
                if(data.results && data.results.length > 0){
                    $.each(data.results, function(i, row){
                        console.log('Processing external facilitator:', row);
                        externalRows += '<tr><td>' + (row.rp_name || '') + '</td></tr>';
                    });
                }
                
                // Update table
                $('#lds-external-facilitator-table-admin tbody').html(externalRows || '<tr><td class="text-center">No external facilitators</td></tr>');
            },
            error: function(xhr, status, error){
                console.log('Error loading external facilitators:', xhr.status, error);
                $('#lds-external-facilitator-table-admin tbody').html('<tr><td class="text-center">Error loading facilitators</td></tr>');
            }
        });
    }

    // Load data when tabs are shown
    $('a[href="#participants"]').on('show.bs.tab', function(){
        loadInternalParticipants();
        loadExternalParticipants();
    });

    $('a[href="#facilitators"]').on('show.bs.tab', function(){
        loadInternalFacilitators();
        loadExternalFacilitators();
    });
    $(document).on('click', '#approve-training-btn', function(){
        Swal.fire({
            title: 'Approve Training (RRSO)?',
            text: 'This will approve the training request (RRSO).',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Approve',
            allowOutsideClick: false,
            showLoaderOnConfirm: true,
            preConfirm: function () {
                return $.ajax({
                    url: '/backend/learning-and-development/rrso/bypass-approval/' + trainingId,
                    type: 'POST',
                    data: { 'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val() },
                }).catch(function (xhr) {
                    var msg = 'Error approving training.';
                    try {
                        if (xhr && xhr.responseJSON && xhr.responseJSON.msg) {
                            msg = xhr.responseJSON.msg;
                        }
                    } catch (e) { }
                    Swal.showValidationMessage(msg);
                    return false;
                });
            },
        }).then(function (result) {
            if (result.value) {
                var okMsg = 'Training approved.';
                try {
                    if (result.value.msg) okMsg = result.value.msg;
                } catch (e) { }

                Swal.fire({
                    title: 'Success!',
                    text: okMsg,
                    icon: 'success',
                    confirmButtonColor: '#3498DB',
                    allowOutsideClick: false,
                }).then(function () {
                    location.reload();
                });
            }
        });
    });

    // Approve RSO Button
    $(document).on('click', '#approve-rso-btn', function(){
        Swal.fire({
            title: 'Approve RSO?',
            text: 'This will approve the RSO.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Approve',
            allowOutsideClick: false,
            showLoaderOnConfirm: true,
            preConfirm: function () {
                return $.ajax({
                    url: '/backend/learning-and-development/rso/bypass-approval/' + trainingId,
                    type: 'POST',
                    data: { 'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val() },
                }).catch(function (xhr) {
                    var msg = 'Error approving RSO.';
                    try {
                        if (xhr && xhr.responseJSON && xhr.responseJSON.msg) {
                            msg = xhr.responseJSON.msg;
                        }
                    } catch (e) { }
                    Swal.showValidationMessage(msg);
                    return false;
                });
            },
        }).then(function (result) {
            if (result.value) {
                var okMsg = 'RSO approved.';
                try {
                    if (result.value.msg) okMsg = result.value.msg;
                } catch (e) { }

                Swal.fire({
                    title: 'Success!',
                    text: okMsg,
                    icon: 'success',
                    confirmButtonColor: '#3498DB',
                    allowOutsideClick: false,
                }).then(function () {
                    location.reload();
                });
            }
        });
    });

    $(document).on('click', '#reject-training-btn', function(){
        Swal.fire({
            title: 'Reject this training?',
            text: 'The training status will be set to rejected and can be resubmitted later.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Reject',
            allowOutsideClick: false,
            showLoaderOnConfirm: true,
            preConfirm: function () {
                return $.ajax({
                    url: '/backend/learning-and-development/details/' + trainingId + '/reject/',
                    type: 'POST',
                    data: { 'csrfmiddlewaretoken': $('[name="csrfmiddlewaretoken"]').val() },
                }).catch(function (xhr) {
                    var msg = 'Error rejecting training.';
                    try {
                        if (xhr && xhr.responseJSON && xhr.responseJSON.msg) {
                            msg = xhr.responseJSON.msg;
                        }
                    } catch (e) { }
                    Swal.showValidationMessage(msg);
                    return false;
                });
            },
        }).then(function (result) {
            if (result.value) {
                var okMsg = 'Training rejected successfully.';
                try {
                    if (result.value.msg) okMsg = result.value.msg;
                } catch (e) { }

                Swal.fire({
                    title: 'Success!',
                    text: okMsg,
                    icon: 'success',
                    confirmButtonColor: '#3498DB',
                    allowOutsideClick: false,
                }).then(function () {
                    location.reload();
                });
            }
        });
    });

    // Update Training Form - REMOVED (admin can only view, not edit)
    // Details are read-only for the requester request
});
</script>
{% endblock %}
