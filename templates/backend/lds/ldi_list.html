{% extends 'layout.html' %}
{% load static %}

{% block style %}
<style>
    .training-title-cell {
        max-width: 520px;
        white-space: normal;
        word-break: break-word;
        display: inline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row px-3 pt-3">
        <div class="col-lg-8">
            <h1 class="font-weight-bold">LDI Plans</h1>
            <ol class="breadcrumb bg-transparent p-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'backend-dashboard' %}">Home</a>
                </li>
                <li class="breadcrumb-item">
                    Admin
                </li>
                <li class="breadcrumb-item">
                    Learning and Development Management
                </li>
                <li class="breadcrumb-item active">
                    <strong>LDI Plans</strong>
                </li>
            </ol>
        </div>
        <div class="col-lg-4 pt-3">
            <div class="float-md-right">
                <button class="btn btn-info" id="create-btn"><i class="fas fa-plus"></i> Create LDI Plan</button>
            </div>
        </div>
    </div>
</div>

<div class="content-wrapper p-4 ml-0">
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-info card-outline">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="training-titles-table" width="100%">
                            <thead>
                                <tr>
                                    <th width="10%" class="text-center" style="display:none;">ID</th>
                                    <th>Training Title</th>
                                    <th width="15%" class="text-center">tt_status</th>
                                    <th width="25%">Added by</th>
                                    <th width="10%" class="text-center">Requests</th>
                                    <th width="10%" class="text-center">Trainees</th>
                                    <th width="10%" class="text-center">Facilitators</th>
                                    <th width="10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="training_title_details" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">TRAINING TITLE DETAILS</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="details-content"></div>
        </div>
    </div>
</div>

<div class="modal" id="training_rso_participants" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">PARTICIPANTS NI BRO</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="participants-content"></div>
        </div>
    </div>
</div>

<div class="modal" id="ldi_plan_details" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">LDI PLAN DETAILS</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="ldi-plan-details-content"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal" id="ldiModal" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">CREATE / EDIT LDI PLAN</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <form id="ldi-form">
                    {% csrf_token %}
                    <input type="hidden" name="ldi_id" id="ldi-id">
                    <input type="hidden" name="training_id" id="ldi-training-id">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Training Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="training_title" id="ldi-training-title" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Training Category</label>
                            <select class="form-control" name="category_id" id="ldi-category-id">
                                <option value="">-- Pending / None --</option>
                                {% for c in categories %}
                                <option value="{{ c.id }}">{{ c.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Quarter <span class="text-danger">*</span></label>
                            <select class="form-control" name="quarter" id="ldi-quarter">
                                <option value="Q1">1st Quarter</option>
                                <option value="Q2">2nd Quarter</option>
                                <option value="Q3">3rd Quarter</option>
                                <option value="Q4">4th Quarter</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Proposed LDI / Activities <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="proposed_ldi_activity" id="ldi-proposed-ldi-activity" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Proposed Date <span class="text-danger">*</span></label>
                            <input type="date" name="proposed_date" id="ldi-proposed-date" class="form-control">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Target Participants <span class="text-danger">*</span></label>
                            <input type="text" name="target_participants" id="ldi-target-participants" class="form-control">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Budget <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" name="budgetary_requirements" id="ldi-budgetary-requirements" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Platform <span class="text-danger">*</span></label>
                            <select class="form-control" name="platform" id="ldi-platform">
                                <option value="Face-to-Face">Face-to-Face</option>
                                <option value="Online">Online</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Venue</label>
                            <input type="text" class="form-control" name="venue" id="ldi-venue">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Target Competencies <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="target_competencies" id="ldi-target-competencies" rows="3"></textarea>
                    </div>

                    <div class="text-right">
                        <button type="submit" class="btn btn-info">Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
const createBtn = document.getElementById('create-btn');
const modal = $('#ldiModal');

// Open modal for new/edit
createBtn.addEventListener('click', function() {
    $('#ldi-id').val('');
    $('#ldi-training-id').val('');
    $('#ldi-form').trigger('reset');
    $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
    $('#ldi-category-id').val('');
    $('#ldi-quarter').val('Q1');
    $('#ldi-platform').val('Face-to-Face');
    modal.modal('show');
});

$(document).on('click', 'a.ldi-plan-title-toggle', function(){
    var trainingId = $(this).data('training-id');
    $('#ldi_plan_details').modal('show').find('#ldi-plan-details-content').load(
        '{% url "ldi_plan_details" 0 %}'.replace('/0/', '/' + trainingId + '/')
    );
});

function initInlineParticipantsDataTables($scope){
    if (!$scope || !$scope.length){
        return;
    }

    $scope.find('.ldi-facilitators-table, .ldi-participants-table').each(function(){
        var $t = $(this);
        if ($.fn.DataTable && $.fn.DataTable.isDataTable($t)){
            $t.DataTable().destroy();
        }

        if ($.fn.DataTable){
            $t.DataTable({
                paging: true,
                searching: true,
                info: true,
                lengthMenu: [10, 25, 50, 100],
                pageLength: 10,
                ordering: true,
                autoWidth: false,
            });
        }
    });
}

function closeAllInlineParticipants($container){
    $container.find('[data-bottom-participants-panel]').addClass('d-none');
    $container.find('[data-bottom-participants-container]').empty();
    $container.removeData('open-rso-id');
}

$(document).on('click', '#ldi-plan-details-content a[data-role=view-participants]', function(e){
    e.preventDefault();

    var rsoId = $(this).data('rso-id');
    var $container = $('#ldi-plan-details-content');
    var $panel = $container.find('[data-bottom-participants-panel]');
    var $target = $container.find('[data-bottom-participants-container]');
    if (!$panel.length || !$target.length){
        return;
    }

    var openId = $container.data('open-rso-id');
    if (String(openId || '') === String(rsoId || '')){
        closeAllInlineParticipants($container);
        return;
    }

    closeAllInlineParticipants($container);
    $container.data('open-rso-id', rsoId);
    $panel.removeClass('d-none');
    $target.html('<div class="text-center p-2">Loading...</div>');

    $target.load(
        '{% url "lds_training_list_participants" 0 %}'.replace('/0/', '/' + rsoId + '/'),
        function(response, status){
            if (status === 'error'){
                $target.html('<div class="text-center text-danger p-2">Unable to load participants.</div>');
                return;
            }
            initInlineParticipantsDataTables($target);
        }
    );
});

function openLdiModalForTraining(trainingId, trainingTitle){
    $.ajax({
        url: '{% url "ldi_plan_get_by_training" 0 %}'.replace('/0/', '/' + trainingId + '/'),
        type: 'GET',
    }).done(function(resp){
        if (resp && resp.data === 'success' && resp.row){
            $('#ldi-id').val(resp.row.id);
            $('#ldi-training-id').val(resp.row.training_id || trainingId);
            $('#ldi-training-title').val(resp.row.training_title || trainingTitle || '');
            $('#ldi-category-id').val(resp.row.category_id || '');
            $('#ldi-quarter').val(resp.row.quarter || 'Q1');
            $('#ldi-platform').val(resp.row.platform || 'Face-to-Face');
            $('#ldi-proposed-ldi-activity').val(resp.row.proposed_ldi_activity || '');
            $('#ldi-proposed-date').val(resp.row.proposed_date || new Date().toISOString().slice(0, 10));
            $('#ldi-target-participants').val(resp.row.target_participants || '');
            $('#ldi-budgetary-requirements').val(resp.row.budgetary_requirements || '');
            $('#ldi-target-competencies').val(resp.row.target_competencies || '');
            $('#ldi-venue').val(resp.row.venue || '');
            modal.modal('show');
        }
    }).fail(function(){
        // no existing plan: create mode
        $('#ldi-id').val('');
        $('#ldi-form').trigger('reset');
        $('#ldi-training-id').val(trainingId);
        $('#ldi-training-title').val(trainingTitle || '');
        $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
        $('#ldi-category-id').val('');
        $('#ldi-quarter').val('Q1');
        $('#ldi-platform').val('Face-to-Face');
        modal.modal('show');
    });
}
var trainingTitlesTable = $('#training-titles-table').DataTable({
    'processing': true,
    'deferRender': true,
    'order': [[ 0, 'desc' ]],
    'lengthMenu': [25,50,100],
    'ajax': {
        'url': '{% url "lds_training_list_ajax" %}',
        'type': 'GET',
    },
    'columnDefs': [
        { 'targets': [0], 'visible': false, 'searchable': false },
    ],
    'columns': [
        { 'data': 'id' },
        {
            'data': 'tt_name',
            'render': function(data, type, row, meta){
                if (type === 'display'){
                    return '<span class="training-title-cell" title="' + (data || '') + '">' + (data || '') + '</span>';
                }
                return data;
            }
        },
        { 'data': 'tt_status', 'className': 'text-center' },
        { 'data': 'added_by' },
        { 'data': 'requests_count', 'className': 'text-center' },
        { 'data': 'trainees_count', 'className': 'text-center' },
        { 'data': 'facilitators_count', 'className': 'text-center' },
        {
            'data': null,
            'orderable': false,
            'searchable': false,
            'render': function(data, type, row, meta){
                return (
                    '<a href="javascript:;" class="mr-2 ldi-plan-title-toggle" data-training-id="' + row.id + '">Details</a>' +
                    '<a href="javascript:;" class="mr-2 ldi-plan-edit-toggle" data-training-id="' + row.id + '">Edit</a>' +
                    '<a href="javascript:;" class="text-danger" data-role="ldi-row-delete" data-id="' + row.id + '">Delete</a>'
                );
            }
        },
    ],
});

$(document).on('click', 'a.ldi-plan-edit-toggle', function(){
    var trainingId = $(this).data('training-id');

    var tr = $(this).closest('tr');
    if (tr.hasClass('child')){
        tr = tr.prev();
    }
    var row = trainingTitlesTable.row(tr).data();
    var trainingTitle = (row && row.tt_name) ? row.tt_name : '';

    openLdiModalForTraining(trainingId, trainingTitle);
});

$(document).on('click', 'button[data-role=ldi-add]', function(){
    var trainingId = $(this).data('training-id');
    var trainingTitle = $(this).data('training-title') || '';

    $('#ldi-id').val('');
    $('#ldi-form').trigger('reset');
    $('#ldi-training-id').val(trainingId);
    $('#ldi-training-title').val(trainingTitle);
    $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
    $('#ldi-category-id').val('');
    $('#ldi-quarter').val('Q1');
    $('#ldi-platform').val('Face-to-Face');

    $('#ldi_plan_details').modal('hide');
    modal.modal('show');
});

$(document).on('click', 'a[data-role=ldi-row-edit]', function(){
    var id = $(this).data('id');
    $.ajax({
        url: '{% url "ldi_plan_get" 0 %}'.replace('/0/', '/' + id + '/'),
        type: 'GET',
    }).done(function(resp){
        if (resp && resp.data === 'success' && resp.row){
            $('#ldi-id').val(resp.row.id);
            $('#ldi-training-id').val(resp.row.training_id || '');
            $('#ldi-training-title').val(resp.row.training_title || '');
            $('#ldi-category-id').val(resp.row.category_id || '');
            $('#ldi-quarter').val(resp.row.quarter);
            $('#ldi-platform').val(resp.row.platform);
            $('#ldi-proposed-ldi-activity').val(resp.row.proposed_ldi_activity);
            $('#ldi-proposed-date').val(resp.row.proposed_date);
            $('#ldi-target-participants').val(resp.row.target_participants);
            $('#ldi-budgetary-requirements').val(resp.row.budgetary_requirements);
            $('#ldi-target-competencies').val(resp.row.target_competencies);
            $('#ldi-venue').val(resp.row.venue);
            $('#ldi_plan_details').modal('hide');
            modal.modal('show');
        }
    });
});

$(document).on('click', 'a[data-role=ldi-row-delete]', function(){
    var id = $(this).data('id');

    Swal.fire({
        title: 'Are you sure?',
        text: 'This will delete the training title.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#E74C3C',
        confirmButtonText: 'Delete',
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        preConfirm: function (){
            return $.ajax({
                url: '/backend/learning-and-development/training-list/delete/' + id + '/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                }
            });
        },
    }).then(function (response){
        if (response.value && response.value.data === 'success'){
            Swal.fire({
                title: 'Deleted!',
                text: 'Training title deleted.',
                icon: 'success',
                confirmButtonColor: '#3498DB',
            }).then(function(){
                trainingTitlesTable.ajax.reload(null, false);
            });
        } else if (response.value && response.value.msg) {
            Swal.fire({
                title: 'Error',
                text: response.value.msg,
                icon: 'error',
                confirmButtonColor: '#3498DB',
            });
        }
    });
});

$('#ldi-form').on('submit', function(e){
    e.preventDefault();
    var form = new FormData(this);

    $.ajax({
        url: '{% url "ldi_plan_save" %}',
        type: 'POST',
        data: form,
        cache: false,
        contentType: false,
        processData: false,
    }).done(function(resp){
        if (resp && resp.data === 'success'){
            Swal.fire({
                title: 'Saved!',
                text: resp.msg || 'LDI plan saved.',
                icon: 'success',
                confirmButtonColor: '#3498DB',
            }).then(function(){
                modal.modal('hide');
                trainingTitlesTable.ajax.reload(null, false);
            });
        } else {
            Swal.fire({
                title: 'Error',
                text: (resp && resp.msg) ? resp.msg : 'Unable to save LDI plan.',
                icon: 'error',
                confirmButtonColor: '#3498DB',
            });
        }
    }).fail(function(xhr){
        var msg = 'Unable to save LDI plan.';
        try {
            if (xhr && xhr.responseJSON && xhr.responseJSON.msg){
                msg = xhr.responseJSON.msg;
            }
        } catch (e) {}
        Swal.fire({
            title: 'Error',
            text: msg,
            icon: 'error',
            confirmButtonColor: '#3498DB',
        });
    });
});
</script>
{% endblock %}
