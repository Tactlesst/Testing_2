{% extends 'layout.html' %}
{% load static %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{% static 'css/adjustments.css' %}">
<style>
    .training-title-cell {
        max-width: 520px;
        white-space: normal;
        word-break: break-word;
        display: inline;
    }
    
    #training-titles-table td,
    #training-titles-table th {
        white-space: normal;
        word-break: break-word;
        vertical-align: top;
        line-height: 1.4;
    }

    #training-titles-table thead th {
        white-space: nowrap;
        word-break: normal;
        vertical-align: middle;
    }

    #training-titles-table td .row-actions {
        opacity: 0.25;
        transition: opacity 0.15s ease-in-out;
        white-space: nowrap;
        vertical-align: middle;
    }

    #training-titles-table tbody tr:hover td .row-actions {
        opacity: 1;
    }

    #training-titles-table td .row-actions a {
        font-size: 12px;
        color: #6c757d;
        text-decoration: none;
    }

    #training-titles-table td .row-actions a:hover {
        color: #343a40;
        text-decoration: underline;
    }

    #training-titles-table td .row-actions a.action-delete {
        color: #dc3545;
    }
    
    /* Responsive table improvements */
    @media (max-width: 768px) {
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #training-titles-table {
            min-width: 800px;
        }
        
        /* Hide less important columns on small screens */
        #training-titles-table th:nth-child(4),
        #training-titles-table td:nth-child(4),
        #training-titles-table th:nth-child(5),
        #training-titles-table td:nth-child(5),
        #training-titles-table th:nth-child(6),
        #training-titles-table td:nth-child(6) {
            display: none;
        }
    }
    
    @media (max-width: 576px) {
        /* Hide more columns on very small screens including Action column */
        #training-titles-table th:nth-child(3),
        #training-titles-table td:nth-child(3),
        #training-titles-table th:nth-child(4),
        #training-titles-table td:nth-child(4),
        #training-titles-table th:nth-child(5),
        #training-titles-table td:nth-child(5),
        #training-titles-table th:nth-child(6),
        #training-titles-table td:nth-child(6),
        #training-titles-table th:nth-child(7),
        #training-titles-table td:nth-child(7),
        #training-titles-table th:nth-child(8),
        #training-titles-table td:nth-child(8),
        #training-titles-table th:nth-child(9),
        #training-titles-table td:nth-child(9),
        #training-titles-table th:nth-child(10),
        #training-titles-table td:nth-child(10) {
            display: none;
        }
        
        #training-titles-table {
            min-width: 400px;
        }
    }
    
    /* Expandable row styles */
    .row-details {
        display: none;
        background-color: #f8f9fa;
        border-left: 3px solid #17a2b8;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .row-details .detail-item {
        padding: 5px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .row-details .detail-item:last-child {
        border-bottom: none;
    }
    
    .row-details .detail-label {
        font-weight: bold;
        color: #495057;
        display: inline-block;
        min-width: 120px;
    }
    
    .row-details .detail-value {
        color: #212529;
    }
    
    /* Clickable row indicator */
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .clickable-row:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row px-3 pt-3">
        <div class="col-lg-8">
            <h1 class="font-weight-bold">LDI Plans</h1>
            <ol class="breadcrumb bg-transparent p-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'backend-dashboard' %}">Home</a>
                </li>
                <li class="breadcrumb-item">
                    Admin
                </li>
                <li class="breadcrumb-item">
                    Learning and Development Management
                </li>
                <li class="breadcrumb-item active">
                    <strong>LDI Plans</strong>
                </li>
            </ol>
        </div>
        <div class="col-lg-4 pt-3">
            <div class="float-md-right">
                <button class="btn btn-info" id="create-btn"><i class="fas fa-plus"></i> Create LDI Plan</button>
            </div>
        </div>
    </div>
</div>

<div class="content-wrapper p-4 ml-0">
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-info card-outline">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="training-titles-table" width="100%">
                            <thead>
                                <tr>
                                    <th width="10%" class="text-center" style="display:none;">ID</th>
                                    <th>Training Title</th>
                                    <th width="15%" class="text-center">tt_status</th>
                                    <th width="25%">Added by</th>
                                    <th width="20%">Venue</th>
                                    <th width="12%" class="text-center">Date Added</th>
                                    <th width="12%" class="text-center">Platform</th>
                                    <th width="10%" class="text-center">Requests</th>
                                    <th width="10%" class="text-center">Trainees</th>
                                    <th width="10%" class="text-center">Facilitators</th>
                                    <th width="10%">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="training_title_details" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">TRAINING TITLE DETAILS</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="details-content"></div>
        </div>
    </div>
</div>

<div class="modal" id="training_rso_participants" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">PARTICIPANTS</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="participants-content"></div>
        </div>
    </div>
</div>

<div class="modal" id="ldi_plan_details" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">LDI PLAN DETAILS</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body" id="ldi-plan-details-content"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal" id="ldiModal" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInDown">
            <div class="modal-header bg-info">
                <h3 class="modal-title">CREATE / EDIT LDI PLAN</h3>
                <button type="button" class="close text-white" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <form id="ldi-form">
                    {% csrf_token %}
                    <input type="hidden" name="ldi_id" id="ldi-id">
                    <input type="hidden" name="training_id" id="ldi-training-id">
                    <input type="hidden" name="created_by_id" id="ldi-created-by-id">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Training Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="training_title" id="ldi-training-title" required>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Training Category</label>
                            <select class="form-control" name="category_id" id="ldi-category-id">
                                <option value="">-- Pending / None --</option>
                                {% for c in categories %}
                                <option value="{{ c.id }}">{{ c.category_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-3">
                            <label>Quarter <span class="text-danger">*</span></label>
                            <select class="form-control" name="quarter" id="ldi-quarter">
                                <option value="Q1">1st Quarter</option>
                                <option value="Q2">2nd Quarter</option>
                                <option value="Q3">3rd Quarter</option>
                                <option value="Q4">4th Quarter</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Proposed LDI / Activities <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="proposed_ldi_activity" id="ldi-proposed-ldi-activity" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label>Proposed Date <span class="text-danger">*</span></label>
                            <input type="date" name="proposed_date" id="ldi-proposed-date" class="form-control">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Target Participants <span class="text-danger">*</span></label>
                            <input type="text" name="target_participants" id="ldi-target-participants" class="form-control">
                        </div>
                        <div class="form-group col-md-4">
                            <label>Budget <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" name="budgetary_requirements" id="ldi-budgetary-requirements" class="form-control">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label>Platform <span class="text-danger">*</span></label>
                            <select class="form-control" name="platform" id="ldi-platform">
                                <option value="Face-to-Face">Face-to-Face</option>
                                <option value="Online">Online</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Venue</label>
                            <input type="text" class="form-control" name="venue" id="ldi-venue">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Target Competencies <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="target_competencies" id="ldi-target-competencies" rows="3"></textarea>
                    </div>

                    <div class="text-right">
                        <button type="submit" class="btn btn-info">Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
const createBtn = document.getElementById('create-btn');
const modal = $('#ldiModal');

// Open modal for new/edit
createBtn.addEventListener('click', function() {
    $('#ldi-id').val('');
    $('#ldi-training-id').val('');
    $('#ldi-form').trigger('reset');
    $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
    $('#ldi-category-id').val('');
    $('#ldi-quarter').val('Q1');
    $('#ldi-platform').val('Face-to-Face');
    $('#ldi-created-by-id').val('{{ request.session.emp_id }}');
    modal.modal('show');
});

$(document).on('click', 'a.ldi-plan-title-toggle', function(){
    var trainingId = $(this).data('training-id');
    $('#ldi_plan_details').modal('show').find('#ldi-plan-details-content').load(
        '{% url "ldi_plan_details" 0 %}'.replace('/0/', '/' + trainingId + '/')
    );
});

function openLdiModalForTraining(trainingId, trainingTitle){
    $.ajax({
        url: '{% url "ldi_plan_get_by_training" 0 %}'.replace('/0/', '/' + trainingId + '/'),
        type: 'GET',
    }).done(function(resp){
        if (resp && resp.data === 'success' && resp.row){
            $('#ldi-id').val(resp.row.id);
            $('#ldi-training-id').val(resp.row.training_id || trainingId);
            $('#ldi-training-title').val(resp.row.training_title || trainingTitle || '');
            $('#ldi-category-id').val(resp.row.category_id || '');
            $('#ldi-quarter').val(resp.row.quarter || 'Q1');
            $('#ldi-platform').val(resp.row.platform || 'Face-to-Face');
            $('#ldi-proposed-ldi-activity').val(resp.row.proposed_ldi_activity || '');
            $('#ldi-proposed-date').val(resp.row.proposed_date || new Date().toISOString().slice(0, 10));
            $('#ldi-target-participants').val(resp.row.target_participants || '');
            $('#ldi-budgetary-requirements').val(resp.row.budgetary_requirements || '');
            $('#ldi-target-competencies').val(resp.row.target_competencies || '');
            $('#ldi-venue').val(resp.row.venue || '');
            modal.modal('show');
        }
    }).fail(function(){
        // no existing plan: create mode
        $('#ldi-id').val('');
        $('#ldi-form').trigger('reset');
        $('#ldi-training-id').val(trainingId);
        $('#ldi-training-title').val(trainingTitle || '');
        $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
        $('#ldi-category-id').val('');
        $('#ldi-quarter').val('Q1');
        $('#ldi-platform').val('Face-to-Face');
        modal.modal('show');
    });
}
var trainingTitlesTable = $('#training-titles-table').DataTable({
    'processing': true,
    'deferRender': true,
    'order': [[ 1, 'desc' ]],
    'lengthMenu': [25,50,100],
    'ajax': {
        'url': '{% url "lds_training_list_ajax" %}',
        'type': 'GET',
    },
    'columnDefs': [],
    'columns': [
        { 'data': 'id', 'visible': false },
        {
            'data': 'tt_name',
            'render': function(data, type, row, meta){
                if (type === 'display'){
                    return '<span class="training-title-cell" title="' + (data || '') + '">' + (data || '') + '</span>';
                }
                return data;
            }
        },
        { 'data': 'tt_status', 'className': 'text-center' },
        { 'data': 'added_by' },
        {
            'data': 'latest_venue',
            'render': function(data, type, row, meta){
                if (type === 'display'){
                    return '<span class="training-title-cell" title="' + (data || '') + '">' + (data || '') + '</span>';
                }
                return data;
            }
        },
        { 'data': 'latest_date_added', 'className': 'text-center' },
        { 'data': 'latest_platform', 'className': 'text-center' },
        { 'data': 'requests_count', 'className': 'text-center' },
        { 'data': 'trainees_count', 'className': 'text-center' },
        { 'data': 'facilitators_count', 'className': 'text-center' },
        {
            'data': null,
            'orderable': false,
            'searchable': false,
            'render': function(data, type, row, meta){
                return (
                    '<span class="row-actions">' +
                        '<a href="javascript:;" class="mr-2 ldi-plan-edit-toggle" data-training-id="' + row.id + '">Edit</a>' +
                        '<a href="javascript:;" class="action-delete" data-role="ldi-row-delete" data-id="' + row.id + '">Delete</a>' +
                    '</span>'
                );
            }
        },
    ],
});

    // Track currently open details row
    var openDetailsRow = null;

    // Handle View Details button click
    $(document).on('click', '.view-details-btn', function(e){
        e.stopPropagation();
        var rowData = JSON.parse(decodeURIComponent($(this).data('row-data')));
        showRowDetails(rowData, $(this));
    });

    // Handle row click for mobile view
    $(document).on('click', '#training-titles-table tbody tr', function(e){
        // Only handle clicks on mobile and not on action buttons
        if ($(window).width() <= 576 && !$(e.target).closest('a, button').length) {
            var row = trainingTitlesTable.row($(this));
            var rowData = row.data();
            if (rowData) {
                showRowDetails(rowData, $(this));
            }
        }
    });

    // Function to show row details
    function showRowDetails(rowData, triggerElement) {
        var currentTr = triggerElement.closest('tr');
        
        // If the clicked row is already open, close it
        if (openDetailsRow && openDetailsRow.is(currentTr)) {
            openDetailsRow.next('.row-details').slideUp(300, function(){
                $(this).remove();
            });
            openDetailsRow = null;
            return;
        }

        // Remove any existing details
        $('.row-details').slideUp(300, function(){
            $(this).remove();
        });
        
        // Create details HTML
        var detailsHtml = '<div class="row-details">' +
            '<div class="detail-item"><span class="detail-label">Status:</span> <span class="detail-value">' + (rowData.tt_status || 'N/A') + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Added by:</span> <span class="detail-value">' + (rowData.added_by || 'N/A') + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Requests:</span> <span class="detail-value">' + (rowData.requests_count || 0) + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Trainees:</span> <span class="detail-value">' + (rowData.trainees_count || 0) + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Facilitators:</span> <span class="detail-value">' + (rowData.facilitators_count || 0) + '</span></div>' +
            '<div class="detail-item"><span class="detail-label">Actions:</span> <span class="detail-value">' +
                '<a href="javascript:;" class="mr-2 ldi-plan-edit-toggle" data-training-id="' + rowData.id + '">Edit</a> ' +
                '<a href="javascript:;" class="text-danger" data-role="ldi-row-delete" data-id="' + rowData.id + '">Delete</a>' +
            '</span></div>' +
            '</div>';
        
        // Insert details after the row
        var targetRow;
        if (triggerElement.hasClass('view-details-btn')) {
            targetRow = triggerElement.closest('tr');
        } else {
            targetRow = triggerElement;
        }
        targetRow.after(detailsHtml);
        
        // Show details with animation
        targetRow.next('.row-details').slideDown(300);
        openDetailsRow = targetRow;
    }

    // Hide details when clicking outside
    $(document).on('click', function(e){
        if (!$(e.target).closest('#training-titles-table, .row-details').length) {
            $('.row-details').slideUp(300, function(){
                $(this).remove();
            });
            openDetailsRow = null;
        }
    });

    // Handle window resize to close details on desktop view
    var resizeTimer;
    $(window).on('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            // If we're on desktop view and details are open, close them
            if ($(window).width() > 576 && openDetailsRow) {
                $('.row-details').slideUp(300, function(){
                    $(this).remove();
                });
                openDetailsRow = null;
            }
        }, 250); // Debounce resize event
    });

$(document).on('click', 'a.ldi-plan-edit-toggle', function(){
    var trainingId = $(this).data('training-id');

    var tr = $(this).closest('tr');
    if (tr.hasClass('child')){
        tr = tr.prev();
    }
    var row = trainingTitlesTable.row(tr).data();
    var trainingTitle = (row && row.tt_name) ? row.tt_name : '';

    openLdiModalForTraining(trainingId, trainingTitle);
});

$(document).on('click', 'button[data-role=ldi-add]', function(){
    var trainingId = $(this).data('training-id');
    var trainingTitle = $(this).data('training-title') || '';

    $('#ldi-id').val('');
    $('#ldi-form').trigger('reset');
    $('#ldi-training-id').val(trainingId);
    $('#ldi-training-title').val(trainingTitle);
    $('#ldi-proposed-date').val(new Date().toISOString().slice(0, 10));
    $('#ldi-category-id').val('');
    $('#ldi-quarter').val('Q1');
    $('#ldi-platform').val('Face-to-Face');

    $('#ldi_plan_details').modal('hide');
    modal.modal('show');
});

$(document).on('click', 'a[data-role=ldi-row-edit]', function(){
    var id = $(this).data('id');
    $.ajax({
        url: '{% url "ldi_plan_get" 0 %}'.replace('/0/', '/' + id + '/'),
        type: 'GET',
    }).done(function(resp){
        if (resp && resp.data === 'success' && resp.row){
            $('#ldi-id').val(resp.row.id);
            $('#ldi-training-id').val(resp.row.training_id || '');
            $('#ldi-training-title').val(resp.row.training_title || '');
            $('#ldi-category-id').val(resp.row.category_id || '');
            $('#ldi-quarter').val(resp.row.quarter);
            $('#ldi-platform').val(resp.row.platform);
            $('#ldi-proposed-ldi-activity').val(resp.row.proposed_ldi_activity);
            $('#ldi-proposed-date').val(resp.row.proposed_date);
            $('#ldi-target-participants').val(resp.row.target_participants);
            $('#ldi-budgetary-requirements').val(resp.row.budgetary_requirements);
            $('#ldi-target-competencies').val(resp.row.target_competencies);
            $('#ldi-venue').val(resp.row.venue);
            $('#ldi-created-by-id').val(resp.row.created_by_id || '{{ request.session.emp_id }}');
            $('#ldi_plan_details').modal('hide');
            modal.modal('show');
        }
    });
});

$(document).on('click', 'a[data-role=ldi-row-delete]', function(){
    var id = $(this).data('id');

    Swal.fire({
        title: 'Are you sure?',
        text: 'This will delete the training title.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#E74C3C',
        confirmButtonText: 'Delete',
        allowOutsideClick: false,
        showLoaderOnConfirm: true,
        preConfirm: function (){
            return $.ajax({
                url: '/backend/learning-and-development/training-list/delete/' + id + '/',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                }
            }).catch(function(xhr){
                var msg = 'Unable to delete.';
                try {
                    if (xhr && xhr.responseJSON && xhr.responseJSON.msg){
                        msg = xhr.responseJSON.msg;
                    }
                } catch (e) {}

                Swal.showValidationMessage(msg);
                return false;
            });
        },
    }).then(function (response){
        if (response.value && response.value.data === 'success'){
            Swal.fire({
                title: 'Deleted!',
                text: 'Training title deleted.',
                icon: 'success',
                confirmButtonColor: '#3498DB',
            }).then(function(){
                trainingTitlesTable.ajax.reload(null, false);
            });
        } else if (response.value && response.value.msg) {
            Swal.fire({
                title: 'Error',
                text: response.value.msg,
                icon: 'error',
                confirmButtonColor: '#3498DB',
            });
        }
    });
});

$('#ldi-form').on('submit', function(e){
    e.preventDefault();
    var form = new FormData(this);

    $.ajax({
        url: '{% url "ldi_plan_save" %}',
        type: 'POST',
        data: form,
        cache: false,
        contentType: false,
        processData: false,
    }).done(function(resp){
        if (resp && resp.data === 'success'){
            Swal.fire({
                title: 'Saved!',
                text: resp.msg || 'LDI plan saved.',
                icon: 'success',
                confirmButtonColor: '#3498DB',
            }).then(function(){
                modal.modal('hide');
                trainingTitlesTable.ajax.reload(null, false);
            });
        } else {
            Swal.fire({
                title: 'Error',
                text: (resp && resp.msg) ? resp.msg : 'Unable to save LDI plan.',
                icon: 'error',
                confirmButtonColor: '#3498DB',
            });
        }
    }).fail(function(xhr){
        var msg = 'Unable to save LDI plan.';
        try {
            if (xhr && xhr.responseJSON && xhr.responseJSON.msg){
                msg = xhr.responseJSON.msg;
            }
        } catch (e) {}
        Swal.fire({
            title: 'Error',
            text: msg,
            icon: 'error',
            confirmButtonColor: '#3498DB',
        });
    });
});
</script>
{% endblock %}
